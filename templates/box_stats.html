<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In-Game Box Stats Analytics - Hoy Sports Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .player-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        .play-entry-form {
            background: #ffffff;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        .stat-badge {
            display: inline-block;
            padding: 2px 6px;
            margin: 1px;
            font-size: 0.8em;
            border-radius: 3px;
            background-color: #f8f9fa;
        }
        .text-purple {
            color: #6f42c1 !important;
        }
        .team-stats-overview {
            background: linear-gradient(135deg, #ff7b7b 0%, #667eea 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .player-input-group {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-chart-line me-2"></i>Hoy Sports Data
            </a>
            <div class="navbar-nav ms-auto">
                {% if session.username and session.username != 'anonymous' %}
                <span class="navbar-text me-3">
                    <i class="fas fa-user me-1"></i>
                    <small class="text-light">Account: <strong>{{ session.username }}</strong></small>
                </span>
                {% endif %}
                <a class="nav-link" href="{{ url_for('index') }}">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="fas fa-football-ball me-3"></i>
                    In-Game Box Stats Analytics
                </h1>
                <p class="text-center text-muted mb-4">
                    Track player statistics in real-time during the game
                </p>
            </div>
        </div>

        <!-- Game Information Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="game-info-section p-3 bg-primary text-white rounded">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-football-ball me-3 h4 mb-0"></i>
                                <div>
                                    <h5 class="mb-1" id="gameNameDisplay">Game Name Not Set</h5>
                                    <small class="opacity-75" id="gameDate">Click "Set Game Info" to name this game session</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-light btn-sm me-2" onclick="showGameInfoModal()">
                                <i class="fas fa-edit me-1"></i>Set Game Info
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="clearGameInfo()">
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phase-Specific Team Stats Overview -->
        <div class="row">
            <!-- Offense Stats -->
            <div class="col-lg-4 col-md-12 mb-3">
                <div class="team-stats-overview">
                    <h5><i class="fas fa-football-ball me-2"></i>Offense</h5>
                    <div class="row">
                        <div class="col-6">
                            <strong>Plays:</strong><br>
                            <span id="offenseTotalPlays" class="h6">0</span>
                        </div>
                        <div class="col-6">
                            <strong>Yards:</strong><br>
                            <span id="offenseTotalYards" class="h6">0</span>
                        </div>
                        <div class="col-6">
                            <strong>TDs:</strong><br>
                            <span id="offenseTouchdowns" class="h6">0</span>
                        </div>
                        <div class="col-6">
                            <strong>Turnovers:</strong><br>
                            <span id="offenseTurnovers" class="h6">0</span>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-4 text-center">
                            <small class="text-success">Efficiency</small><br>
                            <span id="offenseEfficiencyRate" class="badge bg-success">0.0%</span>
                        </div>
                        <div class="col-4 text-center">
                            <small class="text-warning">Explosive</small><br>
                            <span id="offenseExplosiveRate" class="badge bg-warning">0.0%</span>
                        </div>
                        <div class="col-4 text-center">
                            <small class="text-purple">NEE</small><br>
                            <span id="offenseNeeScore" class="badge bg-primary">0.0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Defense Stats -->
            <div class="col-lg-4 col-md-12 mb-3">
                <div class="team-stats-overview">
                    <h5><i class="fas fa-shield-alt me-2"></i>Defense</h5>
                    <div class="row">
                        <div class="col-6">
                            <strong>Plays:</strong><br>
                            <span id="defenseTotalPlays" class="h6">0</span>
                        </div>
                        <div class="col-6">
                            <strong>Yards:</strong><br>
                            <span id="defenseTotalYards" class="h6">0</span>
                        </div>
                        <div class="col-6">
                            <strong>TDs:</strong><br>
                            <span id="defenseTouchdowns" class="h6">0</span>
                        </div>
                        <div class="col-6">
                            <strong>Turnovers:</strong><br>
                            <span id="defenseTurnovers" class="h6">0</span>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-4 text-center">
                            <small class="text-success">Efficiency</small><br>
                            <span id="defenseEfficiencyRate" class="badge bg-success">0.0%</span>
                        </div>
                        <div class="col-4 text-center">
                            <small class="text-warning">Explosive</small><br>
                            <span id="defenseExplosiveRate" class="badge bg-warning">0.0%</span>
                        </div>
                        <div class="col-4 text-center">
                            <small class="text-purple">NEE</small><br>
                            <span id="defenseNeeScore" class="badge bg-primary">0.0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Special Teams Stats -->
            <div class="col-lg-4 col-md-12 mb-3">
                <div class="team-stats-overview">
                    <h5><i class="fas fa-running me-2"></i>Special Teams</h5>
                    <div class="row">
                        <div class="col-6">
                            <strong>Plays:</strong><br>
                            <span id="specialTeamsTotalPlays" class="h6">0</span>
                        </div>
                        <div class="col-6">
                            <strong>Yards:</strong><br>
                            <span id="specialTeamsTotalYards" class="h6">0</span>
                        </div>
                        <div class="col-6">
                            <strong>TDs:</strong><br>
                            <span id="specialTeamsTouchdowns" class="h6">0</span>
                        </div>
                        <div class="col-6">
                            <strong>Turnovers:</strong><br>
                            <span id="specialTeamsTurnovers" class="h6">0</span>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-4 text-center">
                            <small class="text-success">Efficiency</small><br>
                            <span id="specialTeamsEfficiencyRate" class="badge bg-success">0.0%</span>
                        </div>
                        <div class="col-4 text-center">
                            <small class="text-warning">Explosive</small><br>
                            <span id="specialTeamsExplosiveRate" class="badge bg-warning">0.0%</span>
                        </div>
                        <div class="col-4 text-center">
                            <small class="text-purple">NEE</small><br>
                            <span id="specialTeamsNeeScore" class="badge bg-primary">0.0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Team Progression Graphs -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Team Progression Analytics</h5>
                    </div>
                    <div class="card-body">
                        <!-- Offense Progression -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary"><i class="fas fa-football-ball me-2"></i>Offense Progression</h6>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-outline-primary w-100" onclick="showPhaseNeeGraph('offense')">
                                    <i class="fas fa-chart-area me-2"></i>NEE Progression
                                </button>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-outline-success w-100" onclick="showPhaseEfficiencyGraph('offense')">
                                    <i class="fas fa-chart-line me-2"></i>Efficiency Progression
                                </button>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-outline-warning w-100" onclick="showPhaseExplosiveGraph('offense')">
                                    <i class="fas fa-chart-bar me-2"></i>Explosive Progression
                                </button>
                            </div>
                        </div>
                        
                        <!-- Defense Progression -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-danger"><i class="fas fa-shield-alt me-2"></i>Defense Progression</h6>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-outline-primary w-100" onclick="showPhaseNeeGraph('defense')">
                                    <i class="fas fa-chart-area me-2"></i>NEE Progression
                                </button>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-outline-success w-100" onclick="showPhaseEfficiencyGraph('defense')">
                                    <i class="fas fa-chart-line me-2"></i>Efficiency Progression
                                </button>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-outline-warning w-100" onclick="showPhaseExplosiveGraph('defense')">
                                    <i class="fas fa-chart-bar me-2"></i>Explosive Progression
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Game Management Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-gamepad me-2"></i>Game Management</h5>
                        <div class="btn-group">
                            <button class="btn btn-success btn-sm" onclick="showSaveGameModal()">
                                <i class="fas fa-save me-1"></i>Save Game
                            </button>
                            <button class="btn btn-info btn-sm" onclick="showLoadGameModal()">
                                <i class="fas fa-folder-open me-1"></i>Load Game
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="exportStats()">
                                <i class="fas fa-download me-1"></i>Export
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="resetStats()">
                                <i class="fas fa-refresh me-1"></i>Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Saved Rosters Management -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Saved Rosters</h5>
                        <div>
                            <button type="button" class="btn btn-success btn-sm me-2" onclick="showSaveRosterModal()">
                                <i class="fas fa-save"></i> Save Current Roster
                            </button>
                            <button type="button" class="btn btn-info btn-sm" onclick="loadSavedRosters()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="savedRostersContainer">
                            <p class="text-muted">Loading saved rosters...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Player Profiles Management -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Current Player Profiles</h5>
                        <button type="button" class="btn btn-primary btn-sm" onclick="showAddPlayerModal()">
                            <i class="fas fa-plus"></i> Add Player
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="playerProfilesContainer">
                            <p class="text-muted">No player profiles created yet. Add players to get started.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Play Entry Form -->
        <div class="row">
            <div class="col-12">
                <div class="play-entry-form">
                    <h4 class="mb-4">
                        <i class="fas fa-plus-circle me-2"></i>Add New Play
                    </h4>
                    
                    <!-- Phase Selection -->
                    <div class="phase-selection mb-4">
                        <div class="row">
                            <div class="col-12">
                                <label class="form-label fw-bold">Select Phase of Game</label>
                                <div class="btn-group w-100" role="group" aria-label="Game Phase Selection">
                                    <input type="radio" class="btn-check" name="gamePhase" id="phaseOffense" value="offense" onchange="selectGamePhase('offense')">
                                    <label class="btn btn-outline-primary" for="phaseOffense">
                                        <i class="fas fa-arrow-right me-2"></i>Offense
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="gamePhase" id="phaseDefense" value="defense" onchange="selectGamePhase('defense')">
                                    <label class="btn btn-outline-success" for="phaseDefense">
                                        <i class="fas fa-shield-alt me-2"></i>Defense
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="gamePhase" id="phaseSpecialTeams" value="special_teams" onchange="selectGamePhase('special_teams')">
                                    <label class="btn btn-outline-warning" for="phaseSpecialTeams">
                                        <i class="fas fa-star me-2"></i>Special Teams
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Play Entry Form (Initially Hidden) -->
                    <div id="playEntryContainer" style="display: none;">
                    <form id="playForm">
                        <div class="row">
                            <div class="col-md-2">
                                <label for="playNumber" class="form-label">Play #</label>
                                <input type="number" class="form-control" id="playNumber" min="1" required>
                            </div>
                            <div class="col-md-2">
                                <label for="down" class="form-label">
                                    Down 
                                    <span id="downAutoIndicator" class="badge bg-success ms-1 d-none">AUTO</span>
                                </label>
                                <select class="form-select" id="down" required>
                                    <option value="">Select Down</option>
                                    <option value="1">1st Down</option>
                                    <option value="2">2nd Down</option>
                                    <option value="3">3rd Down</option>
                                    <option value="4">4th Down</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="distance" class="form-label">
                                    Distance 
                                    <span id="distanceAutoIndicator" class="badge bg-success ms-1 d-none">AUTO</span>
                                </label>
                                <input type="number" class="form-control" id="distance" min="1" max="99" required>
                            </div>
                            <div class="col-md-3">
                                <label for="fieldPosition" class="form-label">
                                    Field Position 
                                    <span id="fieldPosAutoIndicator" class="badge bg-success ms-1 d-none">AUTO</span>
                                </label>
                                <input type="text" class="form-control" id="fieldPosition" placeholder="e.g., OWN 25" required>
                            </div>
                            <div class="col-md-3">
                                <label for="playType" class="form-label">Play Type</label>
                                <select class="form-select" id="playType" required onchange="updatePlayTypeOptions()">
                                    <option value="">Select Type</option>
                                    <optgroup label="🏈 Offense">
                                        <option value="rush">Rush</option>
                                        <option value="pass">Pass</option>
                                        <option value="kneel">Kneel Down</option>
                                        <option value="spike">Spike</option>
                                    </optgroup>
                                    <optgroup label="🛡️ Defense">
                                        <option value="defensive_play">Defensive Play</option>
                                        <option value="interception_return">Interception Return</option>
                                        <option value="fumble_return">Fumble Return</option>
                                        <option value="safety">Safety</option>
                                    </optgroup>
                                    <optgroup label="⚡ Special Teams">
                                        <option value="punt">Punt</option>
                                        <option value="field_goal">Field Goal</option>
                                        <option value="extra_point">Extra Point</option>
                                        <option value="kickoff">Kickoff</option>
                                        <option value="punt_return">Punt Return</option>
                                        <option value="kickoff_return">Kickoff Return</option>
                                        <option value="blocked_kick">Blocked Kick</option>
                                        <option value="onside_kick">Onside Kick</option>
                                    </optgroup>
                                    <optgroup label="⚠️ Other">
                                        <option value="penalty">Penalty</option>
                                        <option value="timeout">Timeout</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Play Call Row -->
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="playCall" class="form-label">
                                    Play Call <span class="text-muted">(Optional)</span>
                                </label>
                                <input type="text" class="form-control" id="playCall" placeholder="e.g., Power O, Slant, PA Boot">
                                <div class="form-text">Track which plays you're running for analytics</div>
                            </div>
                            <div class="col-md-4">
                                <label for="yardsGained" class="form-label">Yards Gained</label>
                                <input type="number" class="form-control" id="yardsGained" value="0" required>
                            </div>
                            <div class="col-md-4">
                                <label for="result" class="form-label">Result</label>
                                <select class="form-select" id="result">
                                    <option value="">Select Result</option>
                                    <option value="first_down">First Down</option>
                                    <option value="touchdown">Touchdown</option>
                                    <option value="turnover">Turnover</option>
                                    <option value="incomplete">Incomplete</option>
                                    <option value="punt">Punt</option>
                                    <option value="field_goal">Field Goal</option>
                                    <option value="safety">Safety</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Penalty Details (shown only when penalty is selected) -->
                        <div class="row mt-3" id="penaltyDetails" style="display: none;">
                            <div class="col-md-6">
                                <label for="penaltyType" class="form-label">Penalty Type</label>
                                <select class="form-select" id="penaltyType">
                                    <option value="">Select Penalty</option>
                                    <option value="false_start">False Start</option>
                                    <option value="holding">Holding</option>
                                    <option value="pass_interference">Pass Interference</option>
                                    <option value="roughing_passer">Roughing the Passer</option>
                                    <option value="delay_of_game">Delay of Game</option>
                                    <option value="unsportsmanlike">Unsportsmanlike Conduct</option>
                                    <option value="facemask">Facemask</option>
                                    <option value="illegal_formation">Illegal Formation</option>
                                    <option value="encroachment">Encroachment</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="penaltyYards" class="form-label">Penalty Yards</label>
                                <input type="number" class="form-control" id="penaltyYards" value="0" placeholder="e.g., 5, 10, 15">
                            </div>
                            <div class="col-md-3">
                                <label for="penaltyOn" class="form-label">Penalty On</label>
                                <select class="form-select" id="penaltyOn">
                                    <option value="offense">Offense</option>
                                    <option value="defense">Defense</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Auto-calculation status -->
                        <div class="row mt-2" id="autoCalculationStatus" style="display: none;">
                            <div class="col-12">
                                <div class="alert alert-info alert-sm">
                                    <i class="fas fa-robot me-2"></i>
                                    <strong>Auto-calculated:</strong> <span id="autoCalculationReason"></span>
                                    <button type="button" class="btn btn-outline-primary btn-sm ms-2" onclick="toggleAutoCalculation()">
                                        <i class="fas fa-edit me-1"></i>Manual Override
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Players Involved</label>
                                <div class="row mt-2">
                                    <div class="col-md-4">
                                        <select class="form-select" id="positionFilter" onchange="filterPlayersByPosition()">
                                            <option value="">All Positions</option>
                                            <optgroup label="Offense">
                                                <option value="QB">QB</option>
                                                <option value="RB">RB</option>
                                                <option value="FB">FB</option>
                                                <option value="WR">WR</option>
                                                <option value="TE">TE</option>
                                                <option value="C">C</option>
                                                <option value="G">G</option>
                                                <option value="T">T</option>
                                                <option value="OL">OL</option>
                                            </optgroup>
                                            <optgroup label="Defense">
                                                <option value="DE">DE</option>
                                                <option value="DT">DT</option>
                                                <option value="NT">NT</option>
                                                <option value="OLB">OLB</option>
                                                <option value="ILB">ILB</option>
                                                <option value="MLB">MLB</option>
                                                <option value="CB">CB</option>
                                                <option value="S">S</option>
                                                <option value="FS">FS</option>
                                                <option value="SS">SS</option>
                                                <option value="LB">LB</option>
                                                <option value="DB">DB</option>
                                                <option value="DL">DL</option>
                                            </optgroup>
                                            <optgroup label="Special Teams">
                                                <option value="K">K</option>
                                                <option value="P">P</option>
                                                <option value="LS">LS</option>
                                                <option value="H">H</option>
                                                <option value="KR">KR</option>
                                                <option value="PR">PR</option>
                                                <option value="ST">ST</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div class="col-md-5">
                                        <select class="form-select" id="playerSelect" disabled>
                                            <option value="">Select a position first</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addSelectedPlayer()">
                                            <i class="fas fa-plus"></i> Add Player
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Selected Players Display -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <label class="form-label">Selected Players for this Play</label>
                                <div id="playersContainer">
                                    <p class="text-muted">No players selected for this play.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12 text-center">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save me-2"></i>Add Play
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-lg ms-2" onclick="clearForm()">
                                    <i class="fas fa-times me-2"></i>Clear
                                </button>
                            </div>
                        </div>
                    </form>
                    </div> <!-- Close playEntryContainer -->
                </div>
            </div>
        </div>

        <!-- Play Call Analytics Display -->
        <div class="row">
            <div class="col-12">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">
                            <i class="fas fa-play-circle me-2"></i>Play Call Analytics
                        </h4>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshPlayCallAnalytics()">
                            <i class="fas fa-refresh me-2"></i>Refresh
                        </button>
                    </div>
                    <div id="playCallAnalyticsContainer">
                        <p class="text-center text-muted">No play call data yet. Add some plays with play calls to see analytics!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Player Stats Display -->
        <div class="row">
            <div class="col-12">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">
                            <i class="fas fa-users me-2"></i>Player Statistics
                        </h4>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="showEditStatsModal()" id="editStatsBtn" style="display: none;">
                            <i class="fas fa-edit me-2"></i>Edit Stats
                        </button>
                    </div>
                    <div id="playerStatsContainer">
                        <p class="text-center text-muted">No player statistics yet. Add some plays to see player stats!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Plays -->
        <div class="row">
            <div class="col-md-8">
                <!-- Player Profiles Management -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Player Profiles</h5>
                        <button type="button" class="btn btn-primary btn-sm" onclick="showAddPlayerModal()">
                            <i class="fas fa-plus"></i> Add Player
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="playerProfilesContainer">
                            <p class="text-muted">No player profiles created yet. Add players to get started.</p>
                        </div>
                    </div>
                </div>

            </div>
            
            <!-- Recent Plays Section -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Recent Plays</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentPlaysContainer">
                            <p class="text-muted">No plays recorded yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Add Player Modal -->
    <div class="modal fade" id="addPlayerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Player Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addPlayerForm">
                        <div class="mb-3">
                            <label for="playerNumber" class="form-label">Jersey Number *</label>
                            <input type="number" class="form-control" id="playerNumber" min="0" max="99" required>
                        </div>
                        <div class="mb-3">
                            <label for="playerName" class="form-label">Player Name *</label>
                            <input type="text" class="form-control" id="playerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="playerPosition" class="form-label">Position *</label>
                            <select class="form-select" id="playerPosition" required>
                                <option value="">Select Position</option>
                                <optgroup label="Offense">
                                    <option value="QB">QB - Quarterback</option>
                                    <option value="RB">RB - Running Back</option>
                                    <option value="FB">FB - Fullback</option>
                                    <option value="WR">WR - Wide Receiver</option>
                                    <option value="TE">TE - Tight End</option>
                                    <option value="C">C - Center</option>
                                    <option value="G">G - Guard</option>
                                    <option value="T">T - Tackle</option>
                                    <option value="OL">OL - Offensive Line</option>
                                </optgroup>
                                <optgroup label="Defense">
                                    <option value="DE">DE - Defensive End</option>
                                    <option value="DT">DT - Defensive Tackle</option>
                                    <option value="NT">NT - Nose Tackle</option>
                                    <option value="OLB">OLB - Outside Linebacker</option>
                                    <option value="ILB">ILB - Inside Linebacker</option>
                                    <option value="MLB">MLB - Middle Linebacker</option>
                                    <option value="CB">CB - Cornerback</option>
                                    <option value="S">S - Safety</option>
                                    <option value="FS">FS - Free Safety</option>
                                    <option value="SS">SS - Strong Safety</option>
                                    <option value="LB">LB - Linebacker</option>
                                    <option value="DB">DB - Defensive Back</option>
                                    <option value="DL">DL - Defensive Line</option>
                                </optgroup>
                                <optgroup label="Special Teams">
                                    <option value="K">K - Kicker</option>
                                    <option value="P">P - Punter</option>
                                    <option value="LS">LS - Long Snapper</option>
                                    <option value="H">H - Holder</option>
                                    <option value="KR">KR - Kick Returner</option>
                                    <option value="PR">PR - Punt Returner</option>
                                    <option value="ST">ST - Special Teams</option>
                                </optgroup>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePlayerProfile()">Save Player</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Info Modal -->
    <div class="modal fade" id="gameInfoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Set Game Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="gameInfoForm">
                        <div class="mb-3">
                            <label for="gameName" class="form-label">Game Name</label>
                            <input type="text" class="form-control" id="gameName" placeholder="e.g., vs Central High, Homecoming Game, State Championship" required>
                            <div class="form-text">Enter a descriptive name for this game session</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="gameOpponent" class="form-label">Opponent (Optional)</label>
                            <input type="text" class="form-control" id="gameOpponent" placeholder="e.g., Central High School">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label for="gameDate" class="form-label">Game Date</label>
                                <input type="date" class="form-control" id="gameDate">
                            </div>
                            <div class="col-md-6">
                                <label for="gameLocation" class="form-label">Location (Optional)</label>
                                <input type="text" class="form-control" id="gameLocation" placeholder="e.g., Home, Away, Neutral">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveGameInfo()">Save Game Info</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Roster Modal -->
    <div class="modal fade" id="saveRosterModal" tabindex="-1" aria-labelledby="saveRosterModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveRosterModalLabel">Save Current Roster</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="saveRosterForm">
                        <div class="mb-3">
                            <label for="rosterName" class="form-label">Roster Name *</label>
                            <input type="text" class="form-control" id="rosterName" placeholder="e.g., Varsity Team, JV Squad, Practice Team" required>
                            <div class="form-text">Give your roster a memorable name for easy identification.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Current Players to Save:</label>
                            <div id="currentPlayersPreview" class="border rounded p-2 bg-light">
                                <p class="text-muted mb-0">No players to save</p>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="saveCurrentRoster()">Save Roster</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Roster Modal -->
    <div class="modal fade" id="editRosterModal" tabindex="-1" aria-labelledby="editRosterModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editRosterModalLabel">Edit Roster</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editRosterForm">
                        <div class="mb-3">
                            <label for="editRosterName" class="form-label">Roster Name *</label>
                            <input type="text" class="form-control" id="editRosterName" required>
                            <input type="hidden" id="originalRosterName">
                        </div>
                        
                        <div class="mb-3">
                            <h6>Players in Roster</h6>
                            <div id="editRosterPlayersContainer">
                                <!-- Players will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Add New Player</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <input type="number" class="form-control" id="newPlayerNumber" placeholder="Jersey #" min="0" max="99">
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="newPlayerName" placeholder="Player Name">
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="newPlayerPosition">
                                        <option value="">Position</option>
                                        <option value="QB">QB</option>
                                        <option value="RB">RB</option>
                                        <option value="WR">WR</option>
                                        <option value="TE">TE</option>
                                        <option value="OL">OL</option>
                                        <option value="K">K</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-success btn-sm" onclick="addPlayerToEditRoster()">
                                        <i class="fas fa-plus"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedRoster()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Player Stats Modal -->
    <div class="modal fade" id="editStatsModal" tabindex="-1" aria-labelledby="editStatsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editStatsModalLabel">Edit Player Statistics</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Changes to player stats will be applied immediately. Use caution when editing statistics.
                    </div>
                    
                    <div id="editStatsContainer">
                        <!-- Player stats editing forms will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveAllPlayerStats()">
                        <i class="fas fa-save me-2"></i>Save All Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;">
        <!-- Alerts will be dynamically added here -->
    </div>

    <!-- NEE Progression Graph Modal -->
    <div class="modal fade" id="neeGraphModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="neeGraphModalTitle">NEE Progression Graph</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="neeGraphContainer" style="height: 400px;">
                        <canvas id="neeChart"></canvas>
                    </div>
                    <div id="neeGraphLoading" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading NEE progression data...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        NEE Score = Efficiency Rate + Explosive Rate - Negative Rate
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js for NEE progression graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        let currentPlayNumber = 1;
        let playerInputCount = 0;
        let playerProfiles = {}; // Now uses unique IDs as keys
        let nextPlayerId = 1; // Counter for unique player IDs
        let selectedPlayersForPlay = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updatePlayNumber();
            loadStats();
            loadPlayerProfiles();
            loadGameInfo();
            refreshPlayCallAnalytics();  // Load play call analytics on page load
        });

        // Player Profile Management Functions
        function showAddPlayerModal() {
            const modal = new bootstrap.Modal(document.getElementById('addPlayerModal'));
            modal.show();
        }

        function savePlayerProfile() {
            const number = document.getElementById('playerNumber').value;
            const name = document.getElementById('playerName').value;
            const position = document.getElementById('playerPosition').value;

            if (!number || !name || !position) {
                showAlert('Please fill in all required fields', 'danger');
                return;
            }

            // Allow duplicate jersey numbers for offense/defense players
            // Generate unique ID for this player
            const playerId = 'player_' + nextPlayerId++;
            
            // Save player profile with unique ID
            playerProfiles[playerId] = {
                id: playerId,
                number: parseInt(number),
                name: name,
                position: position
            };

            // Save to session storage for persistence
            sessionStorage.setItem('playerProfiles', JSON.stringify(playerProfiles));
            sessionStorage.setItem('nextPlayerId', nextPlayerId.toString());

            // Close modal and refresh display
            const modal = bootstrap.Modal.getInstance(document.getElementById('addPlayerModal'));
            modal.hide();
            
            // Clear form
            document.getElementById('addPlayerForm').reset();
            
            // Refresh displays
            updatePlayerProfilesDisplay();
            updatePositionFilter();
            
            showAlert(`Player #${number} ${name} added successfully!`, 'success');
        }

        function loadPlayerProfiles() {
            try {
                // Check for chunked storage first (for medium/large rosters)
                const chunkCount = parseInt(sessionStorage.getItem('playerProfiles_chunks') || '0');
                
                if (chunkCount > 0) {
                    // Load from chunks
                    console.log(`Loading player profiles from ${chunkCount} chunks`);
                    playerProfiles = {};
                    let loadedChunks = 0;
                    
                    for (let i = 0; i < chunkCount; i++) {
                        const chunkKey = `playerProfiles_chunk_${i}`;
                        const chunk = sessionStorage.getItem(chunkKey);
                        if (chunk) {
                            try {
                                const chunkData = JSON.parse(chunk);
                                Object.assign(playerProfiles, chunkData);
                                loadedChunks++;
                                console.log(`Loaded chunk ${i} with ${Object.keys(chunkData).length} players`);
                            } catch (chunkError) {
                                console.error(`Error parsing chunk ${i}:`, chunkError);
                                sessionStorage.removeItem(chunkKey);
                            }
                        } else {
                            console.warn(`Missing chunk ${i}`);
                        }
                    }
                    
                    console.log(`Successfully loaded ${Object.keys(playerProfiles).length} players from ${loadedChunks}/${chunkCount} chunks`);
                    
                    // If we didn't load all chunks successfully, clean up and try normal storage
                    if (loadedChunks !== chunkCount) {
                        console.warn('Incomplete chunk loading, falling back to normal storage');
                        playerProfiles = {};
                        // Try normal storage as fallback
                        const saved = sessionStorage.getItem('playerProfiles');
                        if (saved) {
                            playerProfiles = JSON.parse(saved);
                            console.log(`Fallback: loaded ${Object.keys(playerProfiles).length} players from normal storage`);
                        }
                    }
                } else {
                    // Load from normal storage
                    const saved = sessionStorage.getItem('playerProfiles');
                    if (saved) {
                        playerProfiles = JSON.parse(saved);
                        console.log(`Loaded ${Object.keys(playerProfiles).length} players from normal storage`);
                    }
                }
                
                // Load nextPlayerId counter
                const savedNextId = sessionStorage.getItem('nextPlayerId');
                if (savedNextId) {
                    nextPlayerId = parseInt(savedNextId);
                }
                
                if (Object.keys(playerProfiles).length > 0) {
                    console.log(`Updating display for ${Object.keys(playerProfiles).length} players`);
                    updatePlayerProfilesDisplay();
                    updatePositionFilter();
                } else {
                    console.log('No player profiles found in storage');
                }
            } catch (e) {
                console.error('Error loading stored player profiles:', e);
                playerProfiles = {};
                // Clean up corrupted storage
                sessionStorage.removeItem('playerProfiles');
                sessionStorage.removeItem('playerProfiles_chunks');
                const existingChunks = parseInt(sessionStorage.getItem('playerProfiles_chunks') || '0');
                for (let i = 0; i < existingChunks; i++) {
                    sessionStorage.removeItem(`playerProfiles_chunk_${i}`);
                }
            }
        }

        function updatePlayerProfilesDisplay() {
            const container = document.getElementById('playerProfilesContainer');
            
            if (Object.keys(playerProfiles).length === 0) {
                container.innerHTML = '<p class="text-muted">No player profiles created yet. Add players to get started.</p>';
                return;
            }

            // Show loading indicator for large rosters
            const playerCount = Object.keys(playerProfiles).length;
            if (playerCount > 50) {
                container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading roster...</div>';
                
                // Use requestAnimationFrame for non-blocking rendering
                requestAnimationFrame(() => {
                    renderPlayerProfiles(container, playerCount);
                });
            } else {
                renderPlayerProfiles(container, playerCount);
            }
        }
        
        function renderPlayerProfiles(container, playerCount) {
            // Use document fragment for efficient DOM manipulation
            const fragment = document.createDocumentFragment();
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row';
            
            // Add player count indicator for large rosters
            if (playerCount > 20) {
                const countDiv = document.createElement('div');
                countDiv.className = 'col-12 mb-2';
                countDiv.innerHTML = `<small class="text-muted"><i class="fas fa-users"></i> ${playerCount} players loaded</small>`;
                rowDiv.appendChild(countDiv);
            }
            
            // Batch process players for better performance
            const players = Object.values(playerProfiles);
            const batchSize = 20;
            
            function processBatch(startIndex) {
                const endIndex = Math.min(startIndex + batchSize, players.length);
                
                for (let i = startIndex; i < endIndex; i++) {
                    const player = players[i];
                    const colDiv = document.createElement('div');
                    colDiv.className = 'col-md-3 mb-2';
                    colDiv.innerHTML = `
                        <div class="card card-body py-2">
                            <small><strong>#${player.number} ${player.name}</strong></small>
                            <small class="text-muted">${player.position}</small>
                            <button class="btn btn-outline-danger btn-sm mt-1" onclick="removePlayerProfile('${player.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    rowDiv.appendChild(colDiv);
                }
                
                // Process next batch asynchronously if there are more players
                if (endIndex < players.length) {
                    setTimeout(() => processBatch(endIndex), 10);
                } else {
                    // All players processed, update DOM
                    fragment.appendChild(rowDiv);
                    container.innerHTML = '';
                    container.appendChild(fragment);
                }
            }
            
            // Start processing
            processBatch(0);
        }

        function removePlayerProfile(playerId) {
            const player = playerProfiles[playerId];
            if (player && confirm(`Remove player #${player.number} ${player.name}?`)) {
                delete playerProfiles[playerId];
                sessionStorage.setItem('playerProfiles', JSON.stringify(playerProfiles));
                updatePlayerProfilesDisplay();
                updatePositionFilter();
                showAlert('Player removed successfully', 'success');
            }
        }

        function updatePositionFilter() {
            const positionFilter = document.getElementById('positionFilter');
            const positions = new Set();
            
            Object.values(playerProfiles).forEach(player => {
                positions.add(player.position);
            });
            
            let html = '<option value="all">All Positions</option>';
            Array.from(positions).sort().forEach(position => {
                html += `<option value="${position}">${position}</option>`;
            });
            
            positionFilter.innerHTML = html;
            
            // Trigger update of player dropdown when position filter changes
            positionFilter.addEventListener('change', updatePlayerDropdown);
        }

        function removePlayerProfile(playerId) {
            const player = playerProfiles[playerId];
            if (player && confirm(`Remove player #${player.number} ${player.name}?`)) {
                delete playerProfiles[playerId];
                sessionStorage.setItem('playerProfiles', JSON.stringify(playerProfiles));
                sessionStorage.setItem('nextPlayerId', nextPlayerId.toString());
                updatePlayerProfilesDisplay();
                updatePositionFilter();
                showAlert('Player removed successfully', 'success');
            }
        }

        function updatePlayerDropdown() {
            const positionFilter = document.getElementById('positionFilter').value;
            const playerSelect = document.getElementById('playerSelect');
            
            // Filter players by position
            const playersInPosition = Object.values(playerProfiles).filter(player => {
                return positionFilter === 'all' || player.position === positionFilter;
            });
            
            if (playersInPosition.length === 0) {
                playerSelect.innerHTML = '<option value="">No players available</option>';
                playerSelect.disabled = true;
                return;
            }

            let html = '<option value="">Select a player</option>';
            playersInPosition.forEach(player => {
                html += `<option value="${player.id}">#${player.number} ${player.name} (${player.position})</option>`;
            });
            
            playerSelect.innerHTML = html;
            playerSelect.disabled = false;
        }

        function addSelectedPlayer() {
            console.log('DEBUG: addSelectedPlayer() called');
            const playerId = document.getElementById('playerSelect').value;
            console.log('DEBUG: Selected player ID:', playerId);
            console.log('DEBUG: Available player profiles:', Object.keys(playerProfiles));
            
            if (!playerId) {
                console.log('DEBUG: No player selected');
                showAlert('Please select a player', 'warning');
                return;
            }

            const player = playerProfiles[playerId];
            if (!player) {
                showAlert('Player not found', 'danger');
                return;
            }

            // Check if this exact player (by ID) already added to this play
            if (selectedPlayersForPlay.find(p => p.id === player.id)) {
                showAlert(`Player #${player.number} ${player.name} already added to this play`, 'warning');
                return;
            }

            // Add player to play
            selectedPlayersForPlay.push({
                id: player.id,
                number: player.number,
                name: player.name,
                position: player.position,
                role: '',
                // Offensive stats
                touchdown: false,
                fumble: false,
                completion: false,
                interception: false,
                // Defensive stats
                tackle: false,
                sack: false,
                interception_def: false,
                pass_breakup: false,
                fumble_recovery: false,
                forced_fumble: false,
                tackle_for_loss: false,
                defensive_td: false,
                return_yards: 0,
                // Special teams stats
                field_goal_made: false,
                extra_point_made: false,
                punt_return: false,
                kickoff_return: false,
                coverage_tackle: false,
                blocked_kick: false,
                special_teams_td: false
            });

            updateSelectedPlayersDisplay();
        }

        function updateSelectedPlayersDisplay() {
            const container = document.getElementById('playersContainer');
            
            if (selectedPlayersForPlay.length === 0) {
                container.innerHTML = '<p class="text-muted">No players selected for this play</p>';
                return;
            }
            
            let html = '';
            selectedPlayersForPlay.forEach((player, index) => {
                html += `
                    <div class="player-input-group mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">#${player.number} ${player.name} (${player.position})</h6>
                            <button class="btn btn-outline-danger btn-sm" onclick="removePlayerFromPlay(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>#${player.number} ${player.name}</strong>
                                <small class="text-muted d-block">${player.position}</small>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" onchange="updatePlayerRole(${index}, this.value)">
                                    ${getRoleOptionsHTML(player.role)}
                                </select>
                            </div>
                            <div class="col-md-4">
                                ${getPhaseSpecificStatOptions(player, index)}
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-danger btn-sm" onclick="removeSelectedPlayer(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    ${getPhaseSpecificStatOptions(player, index)}
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-outline-danger btn-sm" onclick="removeSelectedPlayer(${index})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updatePlayerRole(index, role) {
            selectedPlayersForPlay[index].role = role;
        }

        function updatePlayerEvent(index, event, checked) {
            selectedPlayersForPlay[index][event] = checked;
            
            // Refresh player stats display if interception or fumble recovery changed
            if (event === 'interception_def' || event === 'fumble_recovery') {
                displaySelectedPlayers();
            }
        }

        function removeSelectedPlayer(index) {
            selectedPlayersForPlay.splice(index, 1);
            updateSelectedPlayersDisplay();
        }

        // Add player input group
        function addPlayerInput() {
            playerInputCount++;
            const container = document.getElementById('playersContainer');
            
            const playerDiv = document.createElement('div');
            playerDiv.className = 'player-input-group';
            playerDiv.id = `player-${playerInputCount}`;
            
            playerDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-2">
                        <label class="form-label">Player #</label>
                        <input type="number" class="form-control player-number" min="0" max="99" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control player-name" placeholder="Optional">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Position</label>
                        <input type="text" class="form-control player-position" placeholder="QB, RB, etc.">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Role</label>
                        <select class="form-select player-role">
                            <option value="">Select Role</option>
                            <option value="passer">Passer</option>
                            <option value="rusher">Rusher</option>
                            <option value="receiver">Receiver</option>
                            <option value="blocker">Blocker</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Special Events</label>
                        <div class="form-check-inline">
                            <input class="form-check-input player-touchdown" type="checkbox">
                            <label class="form-check-label">TD</label>
                        </div>
                        <div class="form-check-inline">
                            <input class="form-check-input player-fumble" type="checkbox">
                            <label class="form-check-label">Fumble</label>
                        </div>
                        <div class="form-check-inline">
                            <input class="form-check-input player-completion" type="checkbox">
                            <label class="form-check-label">Complete</label>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-outline-danger btn-sm d-block" onclick="removePlayerInput('${playerInputCount}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(playerDiv);
        }

        // Remove player input group
        function removePlayerInput(id) {
            const element = document.getElementById(`player-${id}`);
            if (element) {
                element.remove();
            }
        }

        // Update play number automatically
        function updatePlayNumber() {
            document.getElementById('playNumber').value = currentPlayNumber;
        }

        // Handle form submission
        document.getElementById('playForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addPlay();
        });

        // Collect player data from selected players
        function collectPlayerData() {
            console.log('DEBUG: Collecting player data from selectedPlayersForPlay:', selectedPlayersForPlay);
            console.log('DEBUG: selectedPlayersForPlay length:', selectedPlayersForPlay.length);
            const collectedData = selectedPlayersForPlay.map(player => ({
                id: player.id,
                number: player.number,
                name: player.name,
                position: player.position,
                role: player.role,
                // Offensive stats
                touchdown: player.touchdown,
                fumble: player.fumble,
                completion: player.completion,
                interception: player.interception,
                // Defensive stats
                tackle: player.tackle,
                sack: player.sack,
                interception_def: player.interception_def,
                pass_breakup: player.pass_breakup,
                fumble_recovery: player.fumble_recovery,
                forced_fumble: player.forced_fumble,
                tackle_for_loss: player.tackle_for_loss,
                defensive_td: player.defensive_td,
                return_yards: player.return_yards,
                // Special teams stats
                field_goal_made: player.field_goal_made,
                extra_point_made: player.extra_point_made,
                punt_return: player.punt_return,
                kickoff_return: player.kickoff_return,
                coverage_tackle: player.coverage_tackle,
                blocked_kick: player.blocked_kick,
                special_teams_td: player.special_teams_td
            }));
            console.log('Collected player data for submission:', collectedData);
            return collectedData;
        }

        // Clear form after submission
        function clearForm() {
            document.getElementById('playForm').reset();
            selectedPlayersForPlay = [];
            updateSelectedPlayersDisplay();
            updatePlayNumber();
            
            // Reset position filter if elements exist
            const positionFilter = document.getElementById('positionFilter');
            const playerSelect = document.getElementById('playerSelect');
            if (positionFilter && playerSelect) {
                positionFilter.value = '';
                playerSelect.innerHTML = '<option value="">Select a position first</option>';
                playerSelect.disabled = true;
            }
        }

        // Load and display stats
        function loadStats() {
            return fetch('/box_stats/get_stats')
            .then(response => response.json())
            .then(data => {
                console.log('loadStats response:', data);
                if (data.success) {
                    updateTeamStats(data.team_stats);
                    updateTeamAdvancedAnalytics(data.team_stats);  // Update team advanced analytics
                    updatePlayerStats(data.box_stats.players);
                    updateRecentPlays(data.box_stats.plays);
                    console.log('About to call updateNextSituation with:', data.next_situation);
                    updateNextSituation(data.next_situation);
                }
                return data;
            })
            .catch(error => {
                console.error('Error loading stats:', error);
                throw error;
            });
        }

        // Update team stats display
        function updateTeamStats(teamStats) {
            // Update phase-specific stats with null checks
            if (teamStats.offense) {
                const offenseTotalPlays = document.getElementById('offenseTotalPlays');
                const offenseTotalYards = document.getElementById('offenseTotalYards');
                const offenseTouchdowns = document.getElementById('offenseTouchdowns');
                const offenseTurnovers = document.getElementById('offenseTurnovers');
                const offenseEfficiencyRate = document.getElementById('offenseEfficiencyRate');
                const offenseExplosiveRate = document.getElementById('offenseExplosiveRate');
                const offenseNeeScore = document.getElementById('offenseNeeScore');
                
                if (offenseTotalPlays) offenseTotalPlays.textContent = teamStats.offense.total_plays || 0;
                if (offenseTotalYards) offenseTotalYards.textContent = teamStats.offense.total_yards || 0;
                if (offenseTouchdowns) offenseTouchdowns.textContent = teamStats.offense.touchdowns || 0;
                if (offenseTurnovers) offenseTurnovers.textContent = teamStats.offense.turnovers || 0;
                if (offenseEfficiencyRate) offenseEfficiencyRate.textContent = (teamStats.offense.efficiency_rate || 0) + '%';
                if (offenseExplosiveRate) offenseExplosiveRate.textContent = (teamStats.offense.explosive_rate || 0) + '%';
                if (offenseNeeScore) offenseNeeScore.textContent = teamStats.offense.nee_score || 0;
            }
            
            if (teamStats.defense) {
                const defenseTotalPlays = document.getElementById('defenseTotalPlays');
                const defenseTotalYards = document.getElementById('defenseTotalYards');
                const defenseTouchdowns = document.getElementById('defenseTouchdowns');
                const defenseTurnovers = document.getElementById('defenseTurnovers');
                const defenseEfficiencyRate = document.getElementById('defenseEfficiencyRate');
                const defenseExplosiveRate = document.getElementById('defenseExplosiveRate');
                const defenseNeeScore = document.getElementById('defenseNeeScore');
                
                if (defenseTotalPlays) defenseTotalPlays.textContent = teamStats.defense.total_plays || 0;
                if (defenseTotalYards) defenseTotalYards.textContent = teamStats.defense.total_yards || 0;
                if (defenseTouchdowns) defenseTouchdowns.textContent = teamStats.defense.touchdowns || 0;
                if (defenseTurnovers) defenseTurnovers.textContent = teamStats.defense.turnovers || 0;
                if (defenseEfficiencyRate) defenseEfficiencyRate.textContent = (teamStats.defense.efficiency_rate || 0) + '%';
                if (defenseExplosiveRate) defenseExplosiveRate.textContent = (teamStats.defense.explosive_rate || 0) + '%';
                if (defenseNeeScore) defenseNeeScore.textContent = teamStats.defense.nee_score || 0;
            }
            
            if (teamStats.special_teams) {
                const specialTeamsTotalPlays = document.getElementById('specialTeamsTotalPlays');
                const specialTeamsTotalYards = document.getElementById('specialTeamsTotalYards');
                const specialTeamsTouchdowns = document.getElementById('specialTeamsTouchdowns');
                const specialTeamsTurnovers = document.getElementById('specialTeamsTurnovers');
                const specialTeamsEfficiencyRate = document.getElementById('specialTeamsEfficiencyRate');
                const specialTeamsExplosiveRate = document.getElementById('specialTeamsExplosiveRate');
                const specialTeamsNeeScore = document.getElementById('specialTeamsNeeScore');
                
                if (specialTeamsTotalPlays) specialTeamsTotalPlays.textContent = teamStats.special_teams.total_plays || 0;
                if (specialTeamsTotalYards) specialTeamsTotalYards.textContent = teamStats.special_teams.total_yards || 0;
                if (specialTeamsTouchdowns) specialTeamsTouchdowns.textContent = teamStats.special_teams.touchdowns || 0;
                if (specialTeamsTurnovers) specialTeamsTurnovers.textContent = teamStats.special_teams.turnovers || 0;
                if (specialTeamsEfficiencyRate) specialTeamsEfficiencyRate.textContent = (teamStats.special_teams.efficiency_rate || 0) + '%';
                if (specialTeamsExplosiveRate) specialTeamsExplosiveRate.textContent = (teamStats.special_teams.explosive_rate || 0) + '%';
                if (specialTeamsNeeScore) specialTeamsNeeScore.textContent = teamStats.special_teams.nee_score || 0;
            }
            
            // Overall stats section removed - phase-specific stats provide all needed information
        }

        // Update player stats display
        function updatePlayerStats(players) {
            const container = document.getElementById('playerStatsContainer');
            const editStatsBtn = document.getElementById('editStatsBtn');
            
            if (!players || Object.keys(players).length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No player statistics yet. Add some plays to see player stats!</p>';
                // Hide edit stats button when no stats available
                if (editStatsBtn) {
                    editStatsBtn.style.display = 'none';
                }
                return;
            }
            
            // Show edit stats button when stats are available
            if (editStatsBtn) {
                editStatsBtn.style.display = 'inline-block';
            }
            
            let html = '<div class="row">';
            
            Object.values(players).forEach(player => {
                const displayName = player.name && player.name.trim() ? player.name : `Player #${player.number}`;
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="player-card">
                            <h6 class="text-dark"><strong>#${player.number} ${displayName}</strong></h6>
                            <small class="text-secondary">${player.position || 'Unknown Position'}</small>
                            <div class="mt-2">
                                <!-- Offensive Stats -->
                                ${player.rushing_attempts > 0 ? `<span class="stat-badge text-dark">Rush: ${player.rushing_attempts} att, ${player.rushing_yards} yds</span>` : ''}
                                ${player.receptions > 0 ? `<span class="stat-badge text-dark">Rec: ${player.receptions} rec, ${player.receiving_yards} yds</span>` : ''}
                                ${player.passing_attempts > 0 ? `<span class="stat-badge text-dark">Pass: ${player.passing_completions}/${player.passing_attempts}, ${player.passing_yards} yds</span>` : ''}
                                ${player.touchdowns > 0 ? `<span class="stat-badge text-success">TD: ${player.touchdowns}</span>` : ''}
                                ${(player.interceptions || 0) > 0 ? `<span class="stat-badge text-warning">INT: ${player.interceptions}</span>` : ''}
                                ${(player.fumbles || 0) > 0 ? `<span class="stat-badge text-danger">Fumbles: ${player.fumbles}</span>` : ''}
                                
                                <!-- Defensive Stats -->
                                ${(player.tackles_total || 0) > 0 ? `<span class="stat-badge text-primary">Tackles: ${player.tackles_solo || 0}+${player.tackles_assisted || 0}=${player.tackles_total}</span>` : ''}
                                ${(player.sacks || 0) > 0 ? `<span class="stat-badge text-primary">Sacks: ${player.sacks}</span>` : ''}
                                ${(player.interceptions_def || 0) > 0 ? `<span class="stat-badge text-primary">INT: ${player.interceptions_def}${(player.return_yards || 0) > 0 ? `, ${player.return_yards} ret yds` : ''}</span>` : ''}
                                ${(player.pass_breakups || 0) > 0 ? `<span class="stat-badge text-primary">PBU: ${player.pass_breakups}</span>` : ''}
                                ${(player.fumble_recoveries || 0) > 0 ? `<span class="stat-badge text-primary">FR: ${player.fumble_recoveries}${(player.return_yards || 0) > 0 && (player.interceptions_def || 0) === 0 ? `, ${player.return_yards} ret yds` : ''}</span>` : ''}
                                ${(player.forced_fumbles || 0) > 0 ? `<span class="stat-badge text-primary">FF: ${player.forced_fumbles}</span>` : ''}
                                ${(player.tackles_for_loss || 0) > 0 ? `<span class="stat-badge text-primary">TFL: ${player.tackles_for_loss}</span>` : ''}
                                ${(player.defensive_tds || 0) > 0 ? `<span class="stat-badge text-success">Def TD: ${player.defensive_tds}</span>` : ''}
                                
                                <!-- Special Teams Stats -->
                                ${(player.field_goals_attempted || 0) > 0 ? `<span class="stat-badge text-info">FG: ${player.field_goals_made || 0}/${player.field_goals_attempted}</span>` : ''}
                                ${(player.extra_points_attempted || 0) > 0 ? `<span class="stat-badge text-info">XP: ${player.extra_points_made || 0}/${player.extra_points_attempted}</span>` : ''}
                                ${(player.punts || 0) > 0 ? `<span class="stat-badge text-info">Punts: ${player.punts}, ${player.punt_yards || 0} yds</span>` : ''}
                                ${(player.kickoff_returns || 0) > 0 ? `<span class="stat-badge text-info">KR: ${player.kickoff_returns}, ${player.kickoff_return_yards || 0} yds</span>` : ''}
                                ${(player.punt_returns || 0) > 0 ? `<span class="stat-badge text-info">PR: ${player.punt_returns}, ${player.punt_return_yards || 0} yds</span>` : ''}
                                ${(player.coverage_tackles || 0) > 0 ? `<span class="stat-badge text-info">Coverage: ${player.coverage_tackles} tackles</span>` : ''}
                                ${(player.blocked_kicks || 0) > 0 ? `<span class="stat-badge text-info">Blocks: ${player.blocked_kicks}</span>` : ''}
                            </div>
                            ${(player.rushing_attempts > 0 || player.receptions > 0 || player.passing_attempts > 0) ? `
                            <div class="mt-2 pt-2 border-top">
                                <small class="text-primary"><strong>Advanced Analytics:</strong></small><br>
                                <span class="stat-badge text-success" title="Efficiency Rate: 1st down ≥4yds, 2nd down ≥50% distance, 3rd/4th down converted">
                                    <i class="fas fa-chart-line"></i> Efficiency: ${player.efficiency_rate || 0}%
                                </span>
                                <span class="stat-badge text-warning" title="Explosive Rate: Rush ≥10yds, Pass ≥15yds">
                                    <i class="fas fa-rocket"></i> Explosive: ${player.explosive_rate || 0}%
                                </span>
                                <span class="stat-badge text-danger" title="Negative Rate: Negative yards or turnovers">
                                    <i class="fas fa-arrow-down"></i> Negative: ${player.negative_rate || 0}%
                                </span>
                                <span class="stat-badge text-purple" title="NEE Score: Net Explosive Efficiency (Efficiency + Explosive - Negative)">
                                    <i class="fas fa-star"></i> NEE: ${player.nee_score || 0}
                                </span>
                                <span class="stat-badge text-info" title="Total plays involved in">
                                    <i class="fas fa-play"></i> Plays: ${player.total_plays || 0}
                                </span>
                            </div>
                            ` : ''}
                            <div class="mt-2 text-center">
                                <button class="btn btn-outline-primary btn-sm mb-1" onclick="showPlayerNeeGraph('${player.id || player.number}')" title="View NEE Progression Graph">
                                    <i class="fas fa-chart-line me-1"></i>NEE
                                </button>
                                <button class="btn btn-outline-success btn-sm mb-1" onclick="showPlayerEfficiencyGraph('${player.id || player.number}')" title="View Efficiency Progression Graph">
                                    <i class="fas fa-chart-line me-1"></i>Efficiency
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="showPlayerAvgYardsGraph('${player.id || player.number}')" title="View Average Yards Progression Graph">
                                    <i class="fas fa-chart-line me-1"></i>Avg Yards
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Update recent plays display
        function updateRecentPlays(plays) {
            const container = document.getElementById('recentPlaysContainer');
            
            // Check if container exists (it might not be in the template)
            if (!container) {
                console.log('recentPlaysContainer not found in template - skipping recent plays update');
                return;
            }
            
            if (!plays || plays.length === 0) {
                container.innerHTML = '<p class="text-muted">No plays recorded yet.</p>';
                return;
            }
            
            // Show ALL plays by default - NO LIMITS
            const defaultDisplayCount = plays.length; // Show all plays
            const maxDisplayCount = window.recentPlaysDisplayCount || defaultDisplayCount;
            // If user specifically requested a limited count, honor it, otherwise show all
            const recentPlays = (window.recentPlaysDisplayCount && window.recentPlaysDisplayCount < plays.length) 
                ? plays.slice(-window.recentPlaysDisplayCount).reverse() 
                : plays.slice().reverse(); // Show ALL plays by default
            let html = '';
            
            // Add controls for showing fewer plays if user wants (but default to ALL)
            if (plays.length > 15) {
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Showing ${recentPlays.length} of ${plays.length} plays</span>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="adjustRecentPlaysDisplay(15)" ${maxDisplayCount === 15 ? 'disabled' : ''}>15</button>
                            <button class="btn btn-outline-secondary" onclick="adjustRecentPlaysDisplay(25)" ${maxDisplayCount === 25 ? 'disabled' : ''}>25</button>
                            <button class="btn btn-outline-secondary" onclick="adjustRecentPlaysDisplay(50)" ${maxDisplayCount === 50 ? 'disabled' : ''}>50</button>
                            <button class="btn btn-outline-secondary" onclick="adjustRecentPlaysDisplay(${plays.length})" ${maxDisplayCount >= plays.length ? 'disabled' : 'active'}>All</button>
                        </div>
                    </div>
                `;
            }
            
            recentPlays.forEach(play => {
                const playerNames = play.players_involved.map(p => `#${p.number}`).join(', ');
                html += `
                    <div class="border-bottom pb-2 mb-2">
                        <strong>Play ${play.play_number}:</strong> 
                        ${play.down}${getOrdinalSuffix(play.down)} & ${play.distance} at ${play.field_position} - 
                        ${play.play_type.toUpperCase()} for ${play.yards_gained} yards
                        ${playerNames ? ` (${playerNames})` : ''}
                        <small class="text-muted d-block">${play.result}</small>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function adjustRecentPlaysDisplay(count) {
            // If count equals total plays, show all plays (unlimited)
            fetch('/box_stats/get_stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.box_stats && data.box_stats.plays) {
                        const totalPlays = data.box_stats.plays.length;
                        window.recentPlaysDisplayCount = (count >= totalPlays) ? totalPlays : count;
                        updateRecentPlays(data.box_stats.plays);
                    }
                })
                .catch(error => {
                    console.error('Error refreshing plays display:', error);
                });
        }

        // Helper function for ordinal numbers
        function getOrdinalSuffix(num) {
            const suffixes = ['th', 'st', 'nd', 'rd'];
            const v = num % 100;
            return suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0];
        }

        // Export stats
        function exportStats() {
            window.location.href = '/box_stats/export';
        }

        // Reset stats
        function resetStats() {
            if (confirm('Are you sure you want to reset all box stats data? This cannot be undone.')) {
                fetch('/box_stats/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Box stats reset successfully!', 'success');
                        currentPlayNumber = 1;
                        updatePlayNumber();
                        loadStats();
                    } else {
                        showAlert('Error resetting stats: ' + (data.error || 'Unknown error'), 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error resetting stats: ' + error.message, 'danger');
                });
            }
        }

        // Utility functions
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.remove('d-none');
            } else {
                spinner.classList.add('d-none');
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-remove alert after 5 seconds
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }

        // Update next situation based on automation
        function updateNextSituation(nextSituation) {
            console.log('updateNextSituation called with:', nextSituation);
            
            if (nextSituation && nextSituation.auto_calculated) {
                console.log('Updating form fields with auto-calculated values');
                
                // Update form fields with auto-calculated values
                document.getElementById('down').value = nextSituation.down;
                document.getElementById('distance').value = nextSituation.distance;
                document.getElementById('fieldPosition').value = nextSituation.field_position;
                
                console.log('Form fields updated:', {
                    down: nextSituation.down,
                    distance: nextSituation.distance,
                    field_position: nextSituation.field_position
                });
                
                // Show auto indicators if they exist
                const downIndicator = document.getElementById('downAutoIndicator');
                const distanceIndicator = document.getElementById('distanceAutoIndicator');
                const fieldPosIndicator = document.getElementById('fieldPosAutoIndicator');
                
                if (downIndicator) downIndicator.classList.remove('d-none');
                if (distanceIndicator) distanceIndicator.classList.remove('d-none');
                if (fieldPosIndicator) fieldPosIndicator.classList.remove('d-none');
                
                // Show auto-calculation status
                const statusElement = document.getElementById('autoCalculationStatus');
                const reasonElement = document.getElementById('autoCalculationReason');
                
                if (statusElement) statusElement.style.display = 'block';
                if (reasonElement) reasonElement.textContent = nextSituation.reason;
                
                // Add visual feedback to auto-filled fields
                ['down', 'distance', 'fieldPosition'].forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.classList.add('border-success');
                        field.style.backgroundColor = '#f8fff8';
                    }
                });
            } else {
                console.log('No auto-calculated situation or invalid data');
                // Hide auto indicators if not auto-calculated
                hideAutoIndicators();
            }
        }

        // Hide auto calculation indicators
        function hideAutoIndicators() {
            document.getElementById('downAutoIndicator').classList.add('d-none');
            document.getElementById('distanceAutoIndicator').classList.add('d-none');
            document.getElementById('fieldPosAutoIndicator').classList.add('d-none');
            document.getElementById('autoCalculationStatus').style.display = 'none';
            
            // Remove visual feedback
            ['down', 'distance', 'fieldPosition'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.classList.remove('border-success');
                field.style.backgroundColor = '';
            });
        }

        // Toggle auto-calculation (allow manual override)
        function toggleAutoCalculation() {
            hideAutoIndicators();
            showAlert('Manual override enabled. You can now edit down, distance, and field position manually.', 'info');
        }

        // Clear form with automation awareness
        function clearForm() {
            document.getElementById('playForm').reset();
            document.getElementById('playersContainer').innerHTML = '';
            playerInputCount = 0;
            updatePlayNumber();
            // Don't hide auto indicators on clear - they'll be updated on next loadStats()
        }

        // Toggle penalty mode when penalty is selected
        function togglePenaltyMode() {
            const playType = document.getElementById('playType').value;
            const penaltyDetails = document.getElementById('penaltyDetails');
            const playersSection = document.querySelector('.col-md-6:has(#positionFilter)').parentElement;
            const resultField = document.getElementById('result');
            const yardsField = document.getElementById('yardsGained');
            
            if (playType === 'penalty') {
                // Show penalty details
                penaltyDetails.style.display = 'block';
                // Hide players section for penalties
                playersSection.style.display = 'none';
                // Update field labels for penalties
                resultField.placeholder = 'e.g., Accepted, Declined';
                yardsField.style.display = 'none'; // Hide regular yards field for penalties
            } else {
                // Hide penalty details
                penaltyDetails.style.display = 'none';
                // Show players section for regular plays
                playersSection.style.display = 'block';
                // Reset field labels
                resultField.placeholder = 'e.g., Complete, Incomplete, Tackle';
                yardsField.style.display = 'block'; // Show regular yards field
            }
        }

        // Enhanced add play function with automation feedback
        function addPlay() {
            // Apply intelligent auto-detection before collecting player data
            applyIntelligentAutoDetection();
            
            const playType = document.getElementById('playType').value;
            let playData = {
                play_number: parseInt(document.getElementById('playNumber').value),
                down: parseInt(document.getElementById('down').value),
                distance: parseInt(document.getElementById('distance').value),
                field_position: document.getElementById('fieldPosition').value,
                play_type: playType,
                play_call: document.getElementById('playCall').value.trim() || null,
                result: document.getElementById('result').value,
                phase: getCurrentPhase(),
                timestamp: new Date().toISOString()
            };
            
            // Handle penalty vs regular play data
            if (playType === 'penalty') {
                playData.penalty_type = document.getElementById('penaltyType').value;
                playData.penalty_yards = parseInt(document.getElementById('penaltyYards').value) || 0;
                playData.penalty_on = document.getElementById('penaltyOn').value;
                playData.yards_gained = 0; // Penalties don't count as offensive yards
                playData.players_involved = []; // No players involved in penalties for stats
            } else {
                playData.yards_gained = parseInt(document.getElementById('yardsGained').value) || 0;
                playData.players_involved = collectPlayerData();
            }

            showLoading(true);

            fetch('/box_stats/add_play', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(playData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Full server response:', data);
                showLoading(false);
                if (data.success) {
                    showAlert('Play added successfully! Next situation auto-calculated.', 'success');
                    
                    // Update play number
                    currentPlayNumber++;
                    updatePlayNumber();
                    
                    // Debug: Check if next_situation exists in response
                    console.log('Checking next_situation in response:', data.next_situation);
                    
                    // Apply automation directly from the response
                    if (data.next_situation) {
                        console.log('Next situation found:', data.next_situation);
                        console.log('Auto calculated?', data.next_situation.auto_calculated);
                        
                        // Apply automation regardless of auto_calculated flag for testing
                        console.log('Applying automation values:', {
                            down: data.next_situation.down,
                            distance: data.next_situation.distance,
                            field_position: data.next_situation.field_position
                        });
                        
                        document.getElementById('down').value = data.next_situation.down || 1;
                        document.getElementById('distance').value = data.next_situation.distance || 10;
                        document.getElementById('fieldPosition').value = data.next_situation.field_position || 'OWN 25';
                        
                        // Show visual feedback
                        ['down', 'distance', 'fieldPosition'].forEach(fieldId => {
                            const field = document.getElementById(fieldId);
                            if (field) {
                                field.classList.add('border-success');
                                field.style.backgroundColor = '#f8fff8';
                                console.log(`Updated field ${fieldId} to:`, field.value);
                            }
                        });
                        
                        showAlert(`Auto-calculated: ${data.next_situation.reason || 'Next situation updated'}`, 'info');
                    } else {
                        console.log('No next_situation in response!');
                    }
                    
                    // Update team advanced analytics if provided
                    if (data.team_stats) {
                        updateTeamAdvancedAnalytics(data.team_stats);
                    }
                    
                    // Clear form and load updated stats
                    clearFormForNextPlay();
                    loadStats();
                    
                    // Refresh play call analytics
                    refreshAnalyticsAfterPlay();
                } else {
                    console.log('Server error:', data.error);
                    showAlert('Error adding play: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                showLoading(false);
                console.error('Error:', error);
                showAlert('Error adding play: ' + error.message, 'danger');
            });
        }

        // Clear form but keep automated values for next play
        function clearFormForNextPlay() {
            // Clear only player-specific and result fields
            document.getElementById('result').value = '';
            document.getElementById('yardsGained').value = '0';
            document.getElementById('playType').value = '';
            
            // Clear selected players for next play
            selectedPlayersForPlay = [];
            updateSelectedPlayersDisplay();
            
            // Reset position filter
            const positionFilter = document.getElementById('positionFilter');
            const playerSelect = document.getElementById('playerSelect');
            if (positionFilter && playerSelect) {
                positionFilter.value = '';
                playerSelect.innerHTML = '<option value="">Select a position first</option>';
                playerSelect.disabled = true;
            }
            
            // IMPORTANT: Do NOT clear down, distance, field position - they are auto-updated by automation
            // Do NOT reset play number - it auto-increments
            console.log('Form cleared for next play - automation fields preserved');
        }

        // Intelligent auto-detection for play types and player roles
        function applyIntelligentAutoDetection() {
            const playType = document.getElementById('playType').value.toLowerCase();
            const result = document.getElementById('result').value.toLowerCase();
            const yardsGained = parseInt(document.getElementById('yardsGained').value) || 0;
            
            // Check for touchdown scenarios
            const isTouchdown = result.includes('touchdown') || result.includes('td') || result.includes('score');
            
            // Apply intelligent detection based on play type and result
            if (playType === 'pass' && selectedPlayersForPlay.length >= 2) {
                applyPassingPlayDetection(isTouchdown, yardsGained);
            } else if (playType === 'rush' && selectedPlayersForPlay.length >= 1) {
                applyRushingPlayDetection(isTouchdown, yardsGained);
            }
            
            // Update the display after auto-detection
            updateSelectedPlayersDisplay();
        }
        
        function applyPassingPlayDetection(isTouchdown, yardsGained) {
            let qbFound = false;
            let wrFound = false;
            
            console.log(`Applying passing play detection - isTouchdown: ${isTouchdown}, players:`, selectedPlayersForPlay);
            
            selectedPlayersForPlay.forEach((player, index) => {
                const position = player.position.toUpperCase();
                
                // Auto-assign QB as passer
                if (position === 'QB' && !qbFound) {
                    player.role = 'passer';
                    player.completion = true; // Assume completion for positive yards or TD
                    if (isTouchdown) {
                        player.touchdown = true;
                        console.log(`Setting TD flag for QB #${player.number}:`, player.touchdown);
                    }
                    qbFound = true;
                    console.log(`Auto-detected: QB #${player.number} as passer with completion${isTouchdown ? ' and TD' : ''}`);
                }
                
                // Auto-assign WR/TE as receiver
                if ((position === 'WR' || position === 'TE') && !wrFound) {
                    player.role = 'receiver';
                    if (isTouchdown) {
                        player.touchdown = true;
                        console.log(`Setting TD flag for ${position} #${player.number}:`, player.touchdown);
                    }
                    wrFound = true;
                    console.log(`Auto-detected: ${position} #${player.number} as receiver${isTouchdown ? ' with TD' : ''}`);
                }
            });
            
            console.log('Players after auto-detection:', selectedPlayersForPlay);
            
            // Show user-friendly notification
            if (qbFound || wrFound) {
                const message = isTouchdown ? 
                    'Auto-detected: Passing TD with completion, reception, and touchdowns assigned. You can modify these if needed.' :
                    'Auto-detected: Completed pass with QB completion and WR reception assigned. You can modify these if needed.';
                showAlert(message, 'info');
            }
        }
        
        function applyRushingPlayDetection(isTouchdown, yardsGained) {
            selectedPlayersForPlay.forEach((player, index) => {
                const position = player.position.toUpperCase();
                
                // Auto-assign RB/QB as rusher
                if (position === 'RB' || position === 'QB') {
                    player.role = 'rusher';
                    if (isTouchdown) {
                        player.touchdown = true;
                        console.log(`Auto-detected: ${position} #${player.number} as rusher with TD`);
                        showAlert(`Auto-detected: Rushing TD for ${position} #${player.number}. You can modify this if needed.`, 'info');
                    } else {
                        console.log(`Auto-detected: ${position} #${player.number} as rusher`);
                    }
                }
            });
        }

        // Saved Roster Management Functions
        function showSaveRosterModal() {
            // Update the current players preview
            updateCurrentPlayersPreview();
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('saveRosterModal'));
            modal.show();
        }
        
        function updateCurrentPlayersPreview() {
            const container = document.getElementById('currentPlayersPreview');
            
            if (Object.keys(playerProfiles).length === 0) {
                container.innerHTML = '<p class="text-muted mb-0">No players to save</p>';
                return;
            }
            
            let html = '<div class="row">';
            Object.values(playerProfiles).forEach(player => {
                html += `
                    <div class="col-6 mb-1">
                        <small class="text-dark">#${player.number} ${player.name} (${player.position})</small>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        function saveCurrentRoster() {
            const rosterName = document.getElementById('rosterName').value.trim();
            
            if (!rosterName) {
                showAlert('Please enter a roster name', 'warning');
                return;
            }
            
            if (Object.keys(playerProfiles).length === 0) {
                showAlert('No player profiles to save', 'warning');
                return;
            }
            
            // Save roster to server
            fetch('/box_stats/save_roster', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    roster_name: rosterName,
                    player_profiles: playerProfiles
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    
                    // Close modal and clear form
                    const modal = bootstrap.Modal.getInstance(document.getElementById('saveRosterModal'));
                    modal.hide();
                    document.getElementById('saveRosterForm').reset();
                    
                    // Refresh saved rosters display
                    loadSavedRosters();
                } else {
                    showAlert('Error saving roster: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error saving roster: ' + error.message, 'danger');
            });
        }
        
        function loadSavedRosters() {
            fetch('/box_stats/get_rosters')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateSavedRostersDisplay(data.rosters);
                } else {
                    showAlert('Error loading rosters: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error loading rosters: ' + error.message, 'danger');
            });
        }
        
        function updateSavedRostersDisplay(rosters) {
            const container = document.getElementById('savedRostersContainer');
            
            if (!rosters || rosters.length === 0) {
                container.innerHTML = '<p class="text-muted">No saved rosters yet. Save your current player profiles to create your first roster.</p>';
                return;
            }
            
            let html = '<div class="row">';
            rosters.forEach(roster => {
                const createdDate = roster.created_at ? new Date(roster.created_at).toLocaleDateString() : 'Unknown';
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card border-primary">
                            <div class="card-body">
                                <h6 class="card-title text-primary">
                                    <i class="fas fa-clipboard-list me-2"></i>${roster.name}
                                </h6>
                                <p class="card-text">
                                    <small class="text-muted">
                                        ${roster.player_count} players • Created ${createdDate}
                                    </small>
                                </p>
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-success btn-sm" data-roster-name="${roster.name}" onclick="loadRosterByButton(this)">
                                        <i class="fas fa-download"></i> Load
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" data-roster-name="${roster.name}" onclick="editRosterByButton(this)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" data-roster-name="${roster.name}" onclick="deleteRosterByButton(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Player Stats Editing Functions
        function showEditStatsModal() {
            // Get current player stats
            fetch('/box_stats/get_stats')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.players && Object.keys(data.players).length > 0) {
                    populateEditStatsModal(data.players);
                    const modal = new bootstrap.Modal(document.getElementById('editStatsModal'));
                    modal.show();
                } else {
                    showAlert('No player statistics to edit', 'warning');
                }
            })
            .catch(error => {
                console.error('Error loading player stats for editing:', error);
                showAlert('Error loading player statistics: ' + error.message, 'danger');
            });
        }
        
        function populateEditStatsModal(players) {
            const container = document.getElementById('editStatsContainer');
            let html = '';
            
            Object.entries(players).forEach(([playerNumber, stats]) => {
                const playerProfile = playerProfiles[playerNumber];
                const playerName = playerProfile ? playerProfile.name : `Player #${playerNumber}`;
                const position = playerProfile ? playerProfile.position : 'Unknown';
                
                html += `
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <strong>#${playerNumber} ${playerName}</strong>
                                <small class="text-muted ms-2">${position}</small>
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Offense Section -->
                            <h6 class="text-primary mb-3">Offensive Stats</h6>
                            <div class="row mb-4">
                                <!-- Passing Stats -->
                                <div class="col-md-4">
                                    <h6 class="text-secondary">Passing</h6>
                                    <div class="mb-2">
                                        <label class="form-label">Completions</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_passing_completions" 
                                               value="${stats.passing_completions || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Attempts</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_passing_attempts" 
                                               value="${stats.passing_attempts || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Passing Yards</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_passing_yards" 
                                               value="${stats.passing_yards || 0}">
                                    </div>
                                </div>
                                
                                <!-- Rushing Stats -->
                                <div class="col-md-4">
                                    <h6 class="text-secondary">Rushing</h6>
                                    <div class="mb-2">
                                        <label class="form-label">Attempts</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_rushing_attempts" 
                                               value="${stats.rushing_attempts || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Rushing Yards</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_rushing_yards" 
                                               value="${stats.rushing_yards || 0}">
                                    </div>
                                </div>
                                
                                <!-- Receiving Stats -->
                                <div class="col-md-4">
                                    <h6 class="text-secondary">Receiving</h6>
                                    <div class="mb-2">
                                        <label class="form-label">Receptions</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_receptions" 
                                               value="${stats.receptions || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Receiving Yards</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_receiving_yards" 
                                               value="${stats.receiving_yards || 0}">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Defense Section -->
                            <h6 class="text-primary mb-3">Defensive Stats</h6>
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <h6 class="text-secondary">Tackles</h6>
                                    <div class="mb-2">
                                        <label class="form-label">Solo Tackles</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_tackles_solo" 
                                               value="${stats.tackles_solo || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Assisted Tackles</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_tackles_assisted" 
                                               value="${stats.tackles_assisted || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Tackles for Loss</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_tackles_for_loss" 
                                               value="${stats.tackles_for_loss || 0}" min="0">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-secondary">Pass Defense</h6>
                                    <div class="mb-2">
                                        <label class="form-label">Sacks</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_sacks" 
                                               value="${stats.sacks || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">QB Hits</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_qb_hits" 
                                               value="${stats.qb_hits || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Pass Breakups</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_pass_breakups" 
                                               value="${stats.pass_breakups || 0}" min="0">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-secondary">Turnovers</h6>
                                    <div class="mb-2">
                                        <label class="form-label">Interceptions</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_interceptions_def" 
                                               value="${stats.interceptions_def || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Fumble Recoveries</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_fumble_recoveries" 
                                               value="${stats.fumble_recoveries || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Forced Fumbles</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_forced_fumbles" 
                                               value="${stats.forced_fumbles || 0}" min="0">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-secondary">Scores</h6>
                                    <div class="mb-2">
                                        <label class="form-label">Defensive TDs</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_defensive_tds" 
                                               value="${stats.defensive_tds || 0}" min="0">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Special Teams Section -->
                            <h6 class="text-primary mb-3">Special Teams Stats</h6>
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <h6 class="text-secondary">Kicking</h6>
                                    <div class="mb-2">
                                        <label class="form-label">FG Made</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_field_goals_made" 
                                               value="${stats.field_goals_made || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">FG Attempted</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_field_goals_attempted" 
                                               value="${stats.field_goals_attempted || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">XP Made</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_extra_points_made" 
                                               value="${stats.extra_points_made || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">XP Attempted</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_extra_points_attempted" 
                                               value="${stats.extra_points_attempted || 0}" min="0">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-secondary">Punting</h6>
                                    <div class="mb-2">
                                        <label class="form-label">Punts</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_punts" 
                                               value="${stats.punts || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Punt Yards</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_punt_yards" 
                                               value="${stats.punt_yards || 0}" min="0">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-secondary">Returns</h6>
                                    <div class="mb-2">
                                        <label class="form-label">Kickoff Returns</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_kickoff_returns" 
                                               value="${stats.kickoff_returns || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">KR Yards</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_kickoff_return_yards" 
                                               value="${stats.kickoff_return_yards || 0}">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Punt Returns</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_punt_returns" 
                                               value="${stats.punt_returns || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">PR Yards</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_punt_return_yards" 
                                               value="${stats.punt_return_yards || 0}">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-secondary">Coverage</h6>
                                    <div class="mb-2">
                                        <label class="form-label">Coverage Tackles</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_coverage_tackles" 
                                               value="${stats.coverage_tackles || 0}" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Blocked Kicks</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_blocked_kicks" 
                                               value="${stats.blocked_kicks || 0}" min="0">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- General Stats -->
                            <h6 class="text-primary mb-3">General Stats</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-2">
                                        <label class="form-label">Total Touchdowns</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_touchdowns" 
                                               value="${stats.touchdowns || 0}" min="0">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-2">
                                        <label class="form-label">Fumbles</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_fumbles" 
                                               value="${stats.fumbles || 0}" min="0">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-2">
                                        <label class="form-label">Interceptions (Thrown)</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               id="edit_${playerNumber}_interceptions" 
                                               value="${stats.interceptions || 0}" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function saveAllPlayerStats() {
            const players = {};
            
            // Get all player numbers from the edit forms
            const editForms = document.querySelectorAll('[id^="edit_"][id$="_passing_completions"]');
            
            editForms.forEach(form => {
                const playerNumber = form.id.split('_')[1];
                
                players[playerNumber] = {
                    // Offensive stats
                    passing_completions: parseInt(document.getElementById(`edit_${playerNumber}_passing_completions`).value) || 0,
                    passing_attempts: parseInt(document.getElementById(`edit_${playerNumber}_passing_attempts`).value) || 0,
                    passing_yards: parseInt(document.getElementById(`edit_${playerNumber}_passing_yards`).value) || 0,
                    rushing_attempts: parseInt(document.getElementById(`edit_${playerNumber}_rushing_attempts`).value) || 0,
                    rushing_yards: parseInt(document.getElementById(`edit_${playerNumber}_rushing_yards`).value) || 0,
                    receptions: parseInt(document.getElementById(`edit_${playerNumber}_receptions`).value) || 0,
                    receiving_yards: parseInt(document.getElementById(`edit_${playerNumber}_receiving_yards`).value) || 0,
                    
                    // Defensive stats
                    tackles_solo: parseInt(document.getElementById(`edit_${playerNumber}_tackles_solo`).value) || 0,
                    tackles_assisted: parseInt(document.getElementById(`edit_${playerNumber}_tackles_assisted`).value) || 0,
                    tackles_for_loss: parseInt(document.getElementById(`edit_${playerNumber}_tackles_for_loss`).value) || 0,
                    sacks: parseInt(document.getElementById(`edit_${playerNumber}_sacks`).value) || 0,
                    qb_hits: parseInt(document.getElementById(`edit_${playerNumber}_qb_hits`).value) || 0,
                    pass_breakups: parseInt(document.getElementById(`edit_${playerNumber}_pass_breakups`).value) || 0,
                    interceptions_def: parseInt(document.getElementById(`edit_${playerNumber}_interceptions_def`).value) || 0,
                    fumble_recoveries: parseInt(document.getElementById(`edit_${playerNumber}_fumble_recoveries`).value) || 0,
                    forced_fumbles: parseInt(document.getElementById(`edit_${playerNumber}_forced_fumbles`).value) || 0,
                    defensive_tds: parseInt(document.getElementById(`edit_${playerNumber}_defensive_tds`).value) || 0,
                    
                    // Special teams stats
                    field_goals_made: parseInt(document.getElementById(`edit_${playerNumber}_field_goals_made`).value) || 0,
                    field_goals_attempted: parseInt(document.getElementById(`edit_${playerNumber}_field_goals_attempted`).value) || 0,
                    extra_points_made: parseInt(document.getElementById(`edit_${playerNumber}_extra_points_made`).value) || 0,
                    extra_points_attempted: parseInt(document.getElementById(`edit_${playerNumber}_extra_points_attempted`).value) || 0,
                    punts: parseInt(document.getElementById(`edit_${playerNumber}_punts`).value) || 0,
                    punt_yards: parseInt(document.getElementById(`edit_${playerNumber}_punt_yards`).value) || 0,
                    kickoff_returns: parseInt(document.getElementById(`edit_${playerNumber}_kickoff_returns`).value) || 0,
                    kickoff_return_yards: parseInt(document.getElementById(`edit_${playerNumber}_kickoff_return_yards`).value) || 0,
                    punt_returns: parseInt(document.getElementById(`edit_${playerNumber}_punt_returns`).value) || 0,
                    punt_return_yards: parseInt(document.getElementById(`edit_${playerNumber}_punt_return_yards`).value) || 0,
                    coverage_tackles: parseInt(document.getElementById(`edit_${playerNumber}_coverage_tackles`).value) || 0,
                    blocked_kicks: parseInt(document.getElementById(`edit_${playerNumber}_blocked_kicks`).value) || 0,
                    
                    // General stats
                    touchdowns: parseInt(document.getElementById(`edit_${playerNumber}_touchdowns`).value) || 0,
                    fumbles: parseInt(document.getElementById(`edit_${playerNumber}_fumbles`).value) || 0,
                    interceptions: parseInt(document.getElementById(`edit_${playerNumber}_interceptions`).value) || 0
                };
            });
            
            // Send updated stats to backend
            fetch('/box_stats/update_player_stats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    players: players
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Player statistics updated successfully!', 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editStatsModal'));
                    modal.hide();
                    
                    // Refresh stats display
                    loadStats();
                } else {
                    showAlert('Error updating player statistics: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error updating player statistics: ' + error.message, 'danger');
            });
        }
        
        // Wrapper functions to handle roster names safely via data attributes
        function loadRosterByButton(button) {
            const rosterName = button.getAttribute('data-roster-name');
            loadRoster(rosterName);
        }
        
        function editRosterByButton(button) {
            const rosterName = button.getAttribute('data-roster-name');
            editRoster(rosterName);
        }
        
        function deleteRosterByButton(button) {
            const rosterName = button.getAttribute('data-roster-name');
            deleteRoster(rosterName);
        }
        
        function loadRoster(rosterName) {
            if (confirm(`Load roster "${rosterName}"? This will replace your current player profiles.`)) {
                // Show loading indicator
                showAlert('Loading roster...', 'info');
                
                fetch('/box_stats/load_roster', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        roster_name: rosterName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Roster loading response:', data);
                    if (data.success) {
                        const playerCount = Object.keys(data.roster.players || {}).length;
                        console.log(`Loading roster with ${playerCount} players:`, data.roster.players);
                        
                        // Check for large roster warning
                        if (playerCount > 100) {
                            if (!confirm(`This roster contains ${playerCount} players. Loading may take a moment. Continue?`)) {
                                return;
                            }
                        }
                        
                        // Validate roster data
                        if (!data.roster.players || typeof data.roster.players !== 'object') {
                            showAlert('Error: Invalid roster data format', 'danger');
                            return;
                        }
                        
                        // Convert roster players to use unique IDs (for backward compatibility)
                        playerProfiles = {};
                        Object.values(data.roster.players).forEach(player => {
                            const playerId = 'player_' + nextPlayerId++;
                            playerProfiles[playerId] = {
                                id: playerId,
                                number: player.number,
                                name: player.name,
                                position: player.position
                            };
                        });
                        
                        // Use efficient storage for all rosters with improved logic
                        try {
                            console.log(`Storing roster with ${playerCount} players`);
                            
                            // Always clean up existing storage first
                            const existingChunks = parseInt(sessionStorage.getItem('playerProfiles_chunks') || '0');
                            for (let i = 0; i < existingChunks; i++) {
                                sessionStorage.removeItem(`playerProfiles_chunk_${i}`);
                            }
                            sessionStorage.removeItem('playerProfiles_chunks');
                            sessionStorage.removeItem('playerProfiles');
                            
                            if (playerCount > 20) {
                                // For medium/large rosters, use chunked storage
                                console.log('Using chunked storage for medium/large roster');
                                const chunks = chunkObject(playerProfiles, 15);
                                console.log(`Created ${chunks.length} chunks for ${playerCount} players`);
                                
                                // Verify chunks before storing
                                let totalPlayersInChunks = 0;
                                chunks.forEach((chunk, index) => {
                                    const chunkSize = Object.keys(chunk).length;
                                    totalPlayersInChunks += chunkSize;
                                    sessionStorage.setItem(`playerProfiles_chunk_${index}`, JSON.stringify(chunk));
                                    console.log(`Stored chunk ${index} with ${chunkSize} players`);
                                });
                                
                                if (totalPlayersInChunks !== playerCount) {
                                    console.error(`Chunk verification failed: expected ${playerCount}, got ${totalPlayersInChunks}`);
                                    throw new Error('Chunking failed - player count mismatch');
                                }
                                
                                sessionStorage.setItem('playerProfiles_chunks', chunks.length.toString());
                                console.log(`Successfully stored ${totalPlayersInChunks} players in ${chunks.length} chunks`);
                            } else {
                                // For smaller rosters, use normal storage
                                console.log('Using normal storage for smaller roster');
                                sessionStorage.setItem('playerProfiles', JSON.stringify(playerProfiles));
                            }
                            
                            // Always save the updated nextPlayerId counter
                            sessionStorage.setItem('nextPlayerId', nextPlayerId.toString());
                            
                            console.log('Roster storage completed successfully');
                        } catch (e) {
                            console.error('Session storage failed:', e);
                            console.warn('Roster will only be available for this session');
                        }
                        
                        // Update displays with loading feedback
                        updatePlayerProfilesDisplay();
                        updatePositionFilter();
                        
                        showAlert(`${data.message} (${playerCount} players loaded)`, 'success');
                    } else {
                        showAlert('Error loading roster: ' + (data.error || 'Unknown error'), 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error loading roster: ' + error.message, 'danger');
                });
            }
        }
        
        // Helper function to chunk objects for efficient storage
        function chunkObject(obj, chunkSize) {
            const entries = Object.entries(obj);
            const chunks = [];
            
            for (let i = 0; i < entries.length; i += chunkSize) {
                const chunk = {};
                entries.slice(i, i + chunkSize).forEach(([key, value]) => {
                    chunk[key] = value;
                });
                chunks.push(chunk);
            }
            
            return chunks;
        }
        
        // Edit roster functionality
        function editRoster(rosterName) {
            // Load roster data for editing
            fetch('/box_stats/load_roster', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    roster_name: rosterName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate edit modal
                    document.getElementById('editRosterName').value = rosterName;
                    document.getElementById('originalRosterName').value = rosterName;
                    
                    // Load players into edit container
                    updateEditRosterPlayersDisplay(data.roster.players || {});
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('editRosterModal'));
                    modal.show();
                } else {
                    showAlert('Error loading roster for editing: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error loading roster for editing: ' + error.message, 'danger');
            });
        }
        
        function updateEditRosterPlayersDisplay(players) {
            const container = document.getElementById('editRosterPlayersContainer');
            
            if (!players || Object.keys(players).length === 0) {
                container.innerHTML = '<p class="text-muted">No players in this roster.</p>';
                return;
            }
            
            let html = '<div class="row">';
            Object.values(players).forEach(player => {
                html += `
                    <div class="col-md-6 mb-2">
                        <div class="card card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>#${player.number} ${player.name}</strong><br>
                                    <small class="text-muted">${player.position}</small>
                                </div>
                                <button class="btn btn-outline-danger btn-sm" onclick="removePlayerFromEditRoster(${player.number})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        let editRosterPlayers = {};
        
        function addPlayerToEditRoster() {
            const number = document.getElementById('newPlayerNumber').value;
            const name = document.getElementById('newPlayerName').value.trim();
            const position = document.getElementById('newPlayerPosition').value;
            
            if (!number || !name || !position) {
                showAlert('Please fill in all player fields', 'warning');
                return;
            }
            
            if (number < 0 || number > 99) {
                showAlert('Jersey number must be between 0 and 99', 'warning');
                return;
            }
            
            // Get current roster players from the display
            const currentRosterName = document.getElementById('originalRosterName').value;
            fetch('/box_stats/load_roster', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    roster_name: currentRosterName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const players = data.roster.players || {};
                    
                    // Allow duplicate jersey numbers for offense/defense players
                    // (removed duplicate validation to allow O/D players to share numbers)
                    
                    // Check if roster would exceed reasonable limits (but allow large rosters)
                    const currentPlayerCount = Object.keys(players).length;
                    if (currentPlayerCount >= 100) {
                        if (!confirm(`This roster already has ${currentPlayerCount} players. Adding more players may impact performance. Continue?`)) {
                            return;
                        }
                    }
                    
                    // Add new player with unique ID
                    const playerId = 'player_' + nextPlayerId++;
                    players[playerId] = {
                        id: playerId,
                        number: parseInt(number),
                        name: name,
                        position: position
                    };
                    
                    // Save the updated roster immediately
                    const rosterName = document.getElementById('editRosterName').value.trim();
                    fetch('/box_stats/save_roster', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            roster_name: rosterName,
                            player_profiles: players,
                            is_edit: true,
                            original_name: currentRosterName
                        })
                    })
                    .then(response => response.json())
                    .then(saveData => {
                        if (saveData.success) {
                            // Update display
                            updateEditRosterPlayersDisplay(players);
                            
                            // Clear form
                            document.getElementById('newPlayerNumber').value = '';
                            document.getElementById('newPlayerName').value = '';
                            document.getElementById('newPlayerPosition').value = '';
                            
                            showAlert(`Player #${number} ${name} added to roster and saved!`, 'success');
                        } else {
                            showAlert('Error saving roster with new player: ' + (saveData.error || 'Unknown error'), 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error saving roster:', error);
                        showAlert('Error saving roster with new player: ' + error.message, 'danger');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error adding player: ' + error.message, 'danger');
            });
        }
        
        function removePlayerFromEditRoster(playerNumber) {
            if (confirm(`Remove player #${playerNumber} from this roster?`)) {
                // Get current roster and remove player
                const currentRosterName = document.getElementById('originalRosterName').value;
                fetch('/box_stats/load_roster', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        roster_name: currentRosterName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const players = data.roster.players || {};
                        delete players[playerNumber];
                        
                        // Save the updated roster immediately
                        const rosterName = document.getElementById('editRosterName').value.trim();
                        fetch('/box_stats/save_roster', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                roster_name: rosterName,
                                player_profiles: players,
                                is_edit: true,
                                original_name: currentRosterName
                            })
                        })
                        .then(response => response.json())
                        .then(saveData => {
                            if (saveData.success) {
                                updateEditRosterPlayersDisplay(players);
                                showAlert(`Player #${playerNumber} removed from roster and saved!`, 'success');
                            } else {
                                showAlert('Error saving roster after removing player: ' + (saveData.error || 'Unknown error'), 'danger');
                            }
                        })
                        .catch(error => {
                            console.error('Error saving roster:', error);
                            showAlert('Error saving roster after removing player: ' + error.message, 'danger');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error removing player: ' + error.message, 'danger');
                });
            }
        }
        
        function saveEditedRoster() {
            const newRosterName = document.getElementById('editRosterName').value.trim();
            const originalRosterName = document.getElementById('originalRosterName').value;
            
            if (!newRosterName) {
                showAlert('Please enter a roster name', 'warning');
                return;
            }
            
            // Get current players from the edit display
            const currentRosterName = document.getElementById('originalRosterName').value;
            fetch('/box_stats/load_roster', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    roster_name: currentRosterName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const updatedRoster = {
                        name: newRosterName,
                        players: data.roster.players || {},
                        player_count: Object.keys(data.roster.players || {}).length,
                        created_at: data.roster.created_at || new Date().toISOString()
                    };
                    
                    // Save the updated roster
                    fetch('/box_stats/save_roster', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            roster_name: newRosterName,
                            player_profiles: updatedRoster.players,
                            is_edit: true,
                            original_name: originalRosterName
                        })
                    })
                    .then(response => response.json())
                    .then(saveData => {
                        if (saveData.success) {
                            showAlert('Roster updated successfully!', 'success');
                            
                            // Close modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('editRosterModal'));
                            modal.hide();
                            
                            // Refresh rosters display
                            loadSavedRosters();
                        } else {
                            showAlert('Error saving roster: ' + (saveData.error || 'Unknown error'), 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Error saving roster: ' + error.message, 'danger');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error updating roster: ' + error.message, 'danger');
            });
        }
        
        function deleteRoster(rosterName) {
            if (confirm(`Are you sure you want to delete roster "${rosterName}"? This cannot be undone.`)) {
                fetch('/box_stats/delete_roster', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        roster_name: rosterName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(data.message, 'success');
                        loadSavedRosters(); // Refresh the display
                    } else {
                        showAlert('Error deleting roster: ' + (data.error || 'Unknown error'), 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error deleting roster: ' + error.message, 'danger');
                });
            }
        }

        // Update team advanced analytics display
        function updateTeamAdvancedAnalytics(teamStats) {
            console.log('Updating team advanced analytics:', teamStats);
            
            // Update team efficiency rate with null checks
            const teamEfficiencyRate = document.getElementById('teamEfficiencyRate');
            const teamEfficientPlays = document.getElementById('teamEfficientPlays');
            const teamTotalPlaysForEfficiency = document.getElementById('teamTotalPlaysForEfficiency');
            
            if (teamEfficiencyRate) teamEfficiencyRate.textContent = `${teamStats.efficiency_rate || 0.0}%`;
            if (teamEfficientPlays) teamEfficientPlays.textContent = teamStats.efficient_plays || 0;
            if (teamTotalPlaysForEfficiency) teamTotalPlaysForEfficiency.textContent = teamStats.total_plays || 0;
            
            // Update team explosive rate
            const teamExplosiveRate = document.getElementById('teamExplosiveRate');
            const teamExplosivePlays = document.getElementById('teamExplosivePlays');
            const teamTotalPlaysForExplosive = document.getElementById('teamTotalPlaysForExplosive');
            
            if (teamExplosiveRate) teamExplosiveRate.textContent = `${teamStats.explosive_rate || 0.0}%`;
            if (teamExplosivePlays) teamExplosivePlays.textContent = teamStats.explosive_plays || 0;
            if (teamTotalPlaysForExplosive) teamTotalPlaysForExplosive.textContent = teamStats.total_plays || 0;
            
            // Update team negative rate
            const teamNegativeRate = document.getElementById('teamNegativeRate');
            const teamNegativePlays = document.getElementById('teamNegativePlays');
            const teamTotalPlaysForNegative = document.getElementById('teamTotalPlaysForNegative');
            
            if (teamNegativeRate) teamNegativeRate.textContent = `${teamStats.negative_rate || 0.0}%`;
            if (teamNegativePlays) teamNegativePlays.textContent = teamStats.negative_plays || 0;
            if (teamTotalPlaysForNegative) teamTotalPlaysForNegative.textContent = teamStats.total_plays || 0;
            
            // Update average yards per play
            const teamAvgYardsPerPlay = document.getElementById('teamAvgYardsPerPlay');
            if (teamAvgYardsPerPlay) teamAvgYardsPerPlay.textContent = teamStats.avg_yards_per_play || 0.0;
            
            // Update NEE score
            const teamNeeScore = document.getElementById('teamNeeScore');
            if (teamNeeScore) teamNeeScore.textContent = teamStats.nee_score || 0.0;
            
            // Add visual feedback for good performance
            const efficiencyElement = document.getElementById('teamEfficiencyRate');
            const explosiveElement = document.getElementById('teamExplosiveRate');
            const negativeElement = document.getElementById('teamNegativeRate');
            const neeElement = document.getElementById('teamNeeScore');
            
            // Color coding based on performance thresholds
            updatePerformanceColor(efficiencyElement, teamStats.efficiency_rate, 'text-success', 'text-warning', 'text-danger', 50, 30);
            updatePerformanceColor(explosiveElement, teamStats.explosive_rate, 'text-warning', 'text-info', 'text-secondary', 20, 10);
            // For negative rate: lower is better, so reverse the color logic
            updatePerformanceColor(negativeElement, teamStats.negative_rate, 'text-danger', 'text-warning', 'text-success', 20, 10);
            updatePerformanceColor(neeElement, teamStats.nee_score, 'text-success', 'text-warning', 'text-danger', 50, 25);
        }
        
        // Helper function to update performance color based on thresholds
        function updatePerformanceColor(element, value, goodClass, okClass, poorClass, goodThreshold, okThreshold) {
            // Check if element exists before manipulating classList
            if (!element) return;
            
            // Remove all color classes
            element.classList.remove('text-success', 'text-warning', 'text-danger', 'text-info', 'text-secondary');
            
            // Apply appropriate color based on value
            if (value >= goodThreshold) {
                element.classList.add(goodClass);
            } else if (value >= okThreshold) {
                element.classList.add(okClass);
            } else {
                element.classList.add(poorClass);
            }
        }

        // Game Information Management Functions
        function showGameInfoModal() {
            // Pre-populate form with current game info if it exists
            loadCurrentGameInfo();
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('gameInfoModal'));
            modal.show();
        }
        
        function loadCurrentGameInfo() {
            // Get current game info from session storage or display
            const currentGameName = document.getElementById('gameNameDisplay').textContent;
            const currentGameDate = document.getElementById('gameDate').textContent;
            
            if (currentGameName && currentGameName !== 'Game Name Not Set') {
                document.getElementById('gameName').value = currentGameName;
            }
            
            // Set today's date as default if no date is set
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('gameDate').value = today;
        }
        
        function saveGameInfo() {
            const gameName = document.getElementById('gameName').value.trim();
            const gameOpponent = document.getElementById('gameOpponent').value.trim();
            const gameDate = document.getElementById('gameDate').value;
            const gameLocation = document.getElementById('gameLocation').value.trim();
            
            if (!gameName) {
                showAlert('Please enter a game name', 'warning');
                return;
            }
            
            const gameInfo = {
                name: gameName,
                opponent: gameOpponent,
                date: gameDate,
                location: gameLocation,
                created_at: new Date().toISOString()
            };
            
            // Save to server
            fetch('/box_stats/set_game_info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(gameInfo)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Game information saved successfully!', 'success');
                    
                    // Update display
                    updateGameInfoDisplay(gameInfo);
                    
                    // Close modal and clear form
                    const modal = bootstrap.Modal.getInstance(document.getElementById('gameInfoModal'));
                    modal.hide();
                    document.getElementById('gameInfoForm').reset();
                } else {
                    showAlert('Error saving game info: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error saving game info: ' + error.message, 'danger');
            });
        }
        
        function loadGameInfo() {
            fetch('/box_stats/get_game_info')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.game_info) {
                    updateGameInfoDisplay(data.game_info);
                }
            })
            .catch(error => {
                console.error('Error loading game info:', error);
            });
        }
        
        function updateGameInfoDisplay(gameInfo) {
            const gameNameDisplay = document.getElementById('gameNameDisplay');
            const gameDateDisplay = document.getElementById('gameDate');
            
            if (gameInfo && gameInfo.name) {
                gameNameDisplay.textContent = gameInfo.name;
                
                let dateText = '';
                if (gameInfo.date) {
                    const date = new Date(gameInfo.date);
                    dateText = date.toLocaleDateString();
                }
                
                if (gameInfo.opponent) {
                    dateText += gameInfo.opponent ? ` • vs ${gameInfo.opponent}` : '';
                }
                
                if (gameInfo.location) {
                    dateText += ` • ${gameInfo.location}`;
                }
                
                gameDateDisplay.textContent = dateText || 'Game information set';
            } else {
                gameNameDisplay.textContent = 'Game Name Not Set';
                gameDateDisplay.textContent = 'Click "Set Game Info" to name this game session';
            }
        }
        
        function clearGameInfo() {
            if (confirm('Are you sure you want to clear the game information?')) {
                fetch('/box_stats/clear_game_info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Game information cleared', 'info');
                        
                        // Reset display
                        document.getElementById('gameNameDisplay').textContent = 'Game Name Not Set';
                        document.getElementById('gameDate').textContent = 'Click "Set Game Info" to name this game session';
                    } else {
                        showAlert('Error clearing game info: ' + (data.error || 'Unknown error'), 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error clearing game info: ' + error.message, 'danger');
                });
            }
        }

        // ===== PHASE SELECTION SYSTEM =====
        
        let selectedGamePhase = null;
        
        function selectGamePhase(phase) {
            selectedGamePhase = phase;
            
            // Show the play entry form
            document.getElementById('playEntryContainer').style.display = 'block';
            
            // Update play type options based on selected phase
            updatePlayTypeOptionsForPhase(phase);
            
            // Clear any existing selections
            document.getElementById('playType').value = '';
            selectedPlayersForPlay = [];
            updateSelectedPlayersDisplay();
            
            // Update form labels and visibility based on phase
            updateFormForPhase(phase);
        }
        
        function updatePlayTypeOptionsForPhase(phase) {
            const playTypeSelect = document.getElementById('playType');
            let options = '<option value="">Select Play Type</option>';
            
            switch(phase) {
                case 'offense':
                    options += `
                        <option value="rush">Rush</option>
                        <option value="pass">Pass</option>
                        <option value="kneel">Kneel Down</option>
                        <option value="spike">Spike</option>
                    `;
                    break;
                case 'defense':
                    options += `
                        <option value="defensive_play">Defensive Play</option>
                        <option value="interception_return">Interception Return</option>
                        <option value="fumble_return">Fumble Return</option>
                        <option value="safety">Safety</option>
                    `;
                    break;
                case 'special_teams':
                    options += `
                        <option value="punt">Punt</option>
                        <option value="field_goal">Field Goal</option>
                        <option value="extra_point">Extra Point</option>
                        <option value="kickoff">Kickoff</option>
                        <option value="punt_return">Punt Return</option>
                        <option value="kickoff_return">Kickoff Return</option>
                        <option value="blocked_kick">Blocked Kick</option>
                        <option value="onside_kick">Onside Kick</option>
                    `;
                    break;
            }
            
            playTypeSelect.innerHTML = options;
        }
        
        function updateFormForPhase(phase) {
            const downField = document.getElementById('down').parentElement;
            const distanceField = document.getElementById('distance').parentElement;
            const fieldPositionField = document.getElementById('fieldPosition').parentElement;
            const yardsGainedLabel = document.querySelector('label[for="yardsGained"]');
            
            // Show/hide down and distance based on phase
            if (phase === 'special_teams') {
                // For special teams, down/distance might not always be relevant
                downField.style.display = 'block';
                distanceField.style.display = 'block';
                fieldPositionField.style.display = 'block';
            } else {
                // For offense and defense, always show
                downField.style.display = 'block';
                distanceField.style.display = 'block';
                fieldPositionField.style.display = 'block';
            }
            
            // Update yards gained label based on phase
            if (yardsGainedLabel) {
                switch(phase) {
                    case 'offense':
                        yardsGainedLabel.textContent = 'Yards Gained';
                        break;
                    case 'defense':
                        yardsGainedLabel.textContent = 'Yards Allowed';
                        break;
                    case 'special_teams':
                        yardsGainedLabel.textContent = 'Yards/Distance';
                        break;
                }
            }
        }

        // ===== PHASE-SPECIFIC STAT OPTIONS =====
        
        function getPhaseSpecificStatOptions(player, index) {
            const currentPhase = getCurrentPhase();
            
            switch(currentPhase) {
                case 'offense':
                    return `
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.touchdown ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'touchdown', this.checked)">
                            <label class="form-check-label">TD</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.fumble ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'fumble', this.checked)">
                            <label class="form-check-label">Fumble</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.completion ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'completion', this.checked)">
                            <label class="form-check-label">Complete</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.interception ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'interception', this.checked)">
                            <label class="form-check-label">INT</label>
                        </div>
                    `;
                    
                case 'defense':
                    return `
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.tackle ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'tackle', this.checked)">
                            <label class="form-check-label">Tackle</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.sack ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'sack', this.checked)">
                            <label class="form-check-label">Sack</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.interception_def ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'interception_def', this.checked)">
                            <label class="form-check-label">INT</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.pass_breakup ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'pass_breakup', this.checked)">
                            <label class="form-check-label">PBU</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.fumble_recovery ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'fumble_recovery', this.checked)">
                            <label class="form-check-label">FR</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.forced_fumble ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'forced_fumble', this.checked)">
                            <label class="form-check-label">FF</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.tackle_for_loss ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'tackle_for_loss', this.checked)">
                            <label class="form-check-label">TFL</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.defensive_td ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'defensive_td', this.checked)">
                            <label class="form-check-label">Def TD</label>
                        </div>
                    `;
                    
                    // Add return yards field if player has interception or fumble recovery
                    if (player.interception_def || player.fumble_recovery) {
                        html += `
                        <div class="mt-2">
                            <label class="form-label">Return Yards:</label>
                            <input type="number" class="form-control form-control-sm" style="width: 80px; display: inline-block;" 
                                   value="${player.return_yards || 0}" min="0" 
                                   onchange="updatePlayerEvent(${index}, 'return_yards', parseInt(this.value) || 0)">
                        </div>
                        `;
                    }
                    
                    return html;
                    
                case 'special_teams':
                    return `
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.field_goal_made ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'field_goal_made', this.checked)">
                            <label class="form-check-label">FG Made</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.extra_point_made ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'extra_point_made', this.checked)">
                            <label class="form-check-label">XP Made</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.punt_return ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'punt_return', this.checked)">
                            <label class="form-check-label">PR</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.kickoff_return ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'kickoff_return', this.checked)">
                            <label class="form-check-label">KR</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.coverage_tackle ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'coverage_tackle', this.checked)">
                            <label class="form-check-label">Coverage</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.blocked_kick ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'blocked_kick', this.checked)">
                            <label class="form-check-label">Block</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.special_teams_td ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'special_teams_td', this.checked)">
                            <label class="form-check-label">ST TD</label>
                        </div>
                    `;
                    
                default:
                    // Fallback to offense options
                    return `
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.touchdown ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'touchdown', this.checked)">
                            <label class="form-check-label">TD</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" ${player.fumble ? 'checked' : ''} onchange="updatePlayerEvent(${index}, 'fumble', this.checked)">
                            <label class="form-check-label">Fumble</label>
                        </div>
                    `;
            }
        }
        
        function getCurrentPhase() {
            // Get the currently selected phase from radio buttons
            const selectedPhase = document.querySelector('input[name="gamePhase"]:checked');
            if (selectedPhase) {
                return selectedPhase.value;
            }
            // Check if we have a stored phase from selectGamePhase
            if (selectedGamePhase) {
                return selectedGamePhase;
            }
            return 'offense'; // Default fallback
        }

        // ===== COMPREHENSIVE PLAY TYPE SYSTEM =====
        
        function updatePlayTypeOptions() {
            const playType = document.getElementById('playType').value;
            const yardsGainedField = document.getElementById('yardsGained');
            const resultField = document.getElementById('result');
            
            // Update yards gained field based on play type
            if (['timeout', 'penalty'].includes(playType)) {
                yardsGainedField.value = 0;
                yardsGainedField.disabled = true;
            } else {
                yardsGainedField.disabled = false;
            }
            
            // Update result options based on play type and phase
            updateResultOptionsForPlayType(playType);
            
            // Clear selected players when play type changes
            selectedPlayersForPlay = [];
            updateSelectedPlayersDisplay();
            
            // Show/hide penalty specific fields
            togglePenaltyMode();
        }
        
        function updateResultOptionsForPlayType(playType) {
            const resultField = document.getElementById('result');
            let options = '<option value="">Select Result</option>';
            
            switch(playType) {
                case 'rush':
                case 'pass':
                    options += `
                        <option value="first_down">First Down</option>
                        <option value="touchdown">Touchdown</option>
                        <option value="fumble">Fumble</option>
                        <option value="incomplete">Incomplete</option>
                        <option value="sack">Sack</option>
                        <option value="safety">Safety</option>
                    `;
                    break;
                case 'defensive_play':
                    options += `
                        <option value="tackle">Tackle</option>
                        <option value="sack">Sack</option>
                        <option value="interception">Interception</option>
                        <option value="fumble_recovery">Fumble Recovery</option>
                        <option value="pass_breakup">Pass Breakup</option>
                        <option value="tackle_for_loss">Tackle for Loss</option>
                    `;
                    break;
                case 'interception_return':
                case 'fumble_return':
                    options += `
                        <option value="return">Return</option>
                        <option value="touchdown">Touchdown</option>
                        <option value="fumble">Fumble</option>
                        <option value="tackled">Tackled</option>
                    `;
                    break;
                case 'safety':
                    options += `
                        <option value="safety">Safety</option>
                    `;
                    break;
                case 'field_goal':
                case 'extra_point':
                    options += `
                        <option value="good">Good</option>
                        <option value="missed">Missed</option>
                        <option value="blocked">Blocked</option>
                    `;
                    break;
                case 'punt':
                    options += `
                        <option value="punt">Punt</option>
                        <option value="blocked">Blocked</option>
                        <option value="touchback">Touchback</option>
                        <option value="downed">Downed</option>
                    `;
                    break;
                case 'kickoff':
                    options += `
                        <option value="touchback">Touchback</option>
                        <option value="return">Return</option>
                        <option value="onside_recovery">Onside Recovery</option>
                        <option value="out_of_bounds">Out of Bounds</option>
                    `;
                    break;
                case 'punt_return':
                case 'kickoff_return':
                    options += `
                        <option value="return">Return</option>
                        <option value="touchdown">Touchdown</option>
                        <option value="fumble">Fumble</option>
                        <option value="fair_catch">Fair Catch</option>
                    `;
                    break;
                case 'blocked_kick':
                    options += `
                        <option value="blocked">Blocked</option>
                        <option value="recovered">Recovered</option>
                        <option value="touchdown">Touchdown</option>
                    `;
                    break;
                case 'onside_kick':
                    options += `
                        <option value="recovered">Recovered</option>
                        <option value="failed">Failed</option>
                        <option value="out_of_bounds">Out of Bounds</option>
                    `;
                    break;
                case 'kneel':
                    options += `
                        <option value="kneel">Kneel Down</option>
                    `;
                    break;
                case 'spike':
                    options += `
                        <option value="spike">Spike</option>
                    `;
                    break;
                default:
                    options += `
                        <option value="first_down">First Down</option>
                        <option value="touchdown">Touchdown</option>
                        <option value="incomplete">Incomplete</option>
                        <option value="fumble">Fumble</option>
                    `;
            }
            
            resultField.innerHTML = options;
        }
        
        function getRoleOptionsForPlayType(playType) {
            switch(playType) {
                case 'rush':
                case 'pass':
                    return [
                        {value: 'rusher', label: 'Rusher'},
                        {value: 'receiver', label: 'Receiver'},
                        {value: 'passer', label: 'Passer'},
                        {value: 'blocker', label: 'Blocker'}
                    ];
                case 'defensive_play':
                case 'interception_return':
                case 'fumble_return':
                    return [
                        {value: 'tackler', label: 'Tackler'},
                        {value: 'assist', label: 'Assist'},
                        {value: 'sacker', label: 'Sacker'},
                        {value: 'interceptor', label: 'Interceptor'},
                        {value: 'fumble_forcer', label: 'Fumble Forcer'},
                        {value: 'fumble_recoverer', label: 'Fumble Recoverer'},
                        {value: 'pass_breakup', label: 'Pass Breakup'}
                    ];
                case 'field_goal':
                case 'extra_point':
                    return [
                        {value: 'kicker', label: 'Kicker'},
                        {value: 'holder', label: 'Holder'},
                        {value: 'snapper', label: 'Snapper'},
                        {value: 'blocker', label: 'Blocker'}
                    ];
                case 'punt':
                    return [
                        {value: 'punter', label: 'Punter'},
                        {value: 'snapper', label: 'Snapper'},
                        {value: 'coverage', label: 'Coverage'},
                        {value: 'blocker', label: 'Blocker'}
                    ];
                case 'kickoff':
                    return [
                        {value: 'kicker', label: 'Kicker'},
                        {value: 'coverage', label: 'Coverage'}
                    ];
                case 'punt_return':
                case 'kickoff_return':
                    return [
                        {value: 'returner', label: 'Returner'},
                        {value: 'blocker', label: 'Blocker'},
                        {value: 'coverage_tackler', label: 'Coverage Tackler'}
                    ];
                default:
                    return [
                        {value: 'player', label: 'Player'}
                    ];
            }
        }
        
        function getRoleOptionsHTML(selectedRole) {
            const playType = document.getElementById('playType').value;
            const roleOptions = getRoleOptionsForPlayType(playType);
            
            let html = '<option value="">Select Role</option>';
            roleOptions.forEach(option => {
                const selected = option.value === selectedRole ? 'selected' : '';
                html += `<option value="${option.value}" ${selected}>${option.label}</option>`;
            });
            
            return html;
        }

        // Player profile system handles player selection - no auto-add needed

        // ===== PLAY CALL ANALYTICS FUNCTIONS =====

        function refreshPlayCallAnalytics() {
            fetch('/box_stats/play_call_analytics')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayPlayCallAnalytics(data.play_call_analytics);
                } else {
                    showAlert('Error loading play call analytics: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error loading play call analytics: ' + error.message, 'danger');
            });
        }

        function displayPlayCallAnalytics(playCallAnalytics) {
            const container = document.getElementById('playCallAnalyticsContainer');
            
            if (playCallAnalytics.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No play call data yet. Add some plays with play calls to see analytics!</p>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-striped table-hover">';
            html += `
                <thead class="table-dark">
                    <tr>
                        <th>Play Call</th>
                        <th>Uses</th>
                        <th>Avg Yards</th>
                        <th>Success Rate</th>
                        <th>Efficiency</th>
                        <th>Explosive</th>
                        <th>NEE Score</th>
                        <th>TDs</th>
                        <th>Turnovers</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
            `;

            playCallAnalytics.forEach(play => {
                const successBadge = getSuccessRateBadge(play.success_rate);
                const neeBadge = getNEEBadge(play.nee_score);
                const efficiencyBadge = getEfficiencyBadge(play.efficiency_rate);
                const explosiveBadge = getExplosiveBadge(play.explosive_rate);

                html += `
                    <tr>
                        <td><strong>${play.play_call}</strong></td>
                        <td><span class="badge bg-secondary">${play.total_plays}</span></td>
                        <td>${play.avg_yards_per_play}</td>
                        <td>${successBadge}</td>
                        <td>${efficiencyBadge}</td>
                        <td>${explosiveBadge}</td>
                        <td>${neeBadge}</td>
                        <td><span class="badge bg-success">${play.touchdowns}</span></td>
                        <td><span class="badge bg-danger">${play.turnovers}</span></td>
                        <td>
                            <button class="btn btn-outline-info btn-sm" onclick="showPlayCallDetails('${play.play_call}')">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function getSuccessRateBadge(rate) {
            if (rate >= 70) return `<span class="badge bg-success">${rate}%</span>`;
            if (rate >= 50) return `<span class="badge bg-warning">${rate}%</span>`;
            return `<span class="badge bg-danger">${rate}%</span>`;
        }

        function getNEEBadge(score) {
            if (score >= 50) return `<span class="badge bg-success">${score}</span>`;
            if (score >= 25) return `<span class="badge bg-warning">${score}</span>`;
            return `<span class="badge bg-danger">${score}</span>`;
        }

        function getEfficiencyBadge(rate) {
            if (rate >= 60) return `<span class="badge bg-success">${rate}%</span>`;
            if (rate >= 40) return `<span class="badge bg-warning">${rate}%</span>`;
            return `<span class="badge bg-danger">${rate}%</span>`;
        }

        function getExplosiveBadge(rate) {
            if (rate >= 30) return `<span class="badge bg-success">${rate}%</span>`;
            if (rate >= 15) return `<span class="badge bg-warning">${rate}%</span>`;
            return `<span class="badge bg-danger">${rate}%</span>`;
        }

        function showPlayCallDetails(playCall) {
            // This could be expanded to show detailed breakdown
            showAlert(`Detailed analytics for "${playCall}" - Feature coming soon!`, 'info');
        }

        // Auto-refresh play call analytics after adding a play
        function refreshAnalyticsAfterPlay() {
            setTimeout(() => {
                refreshPlayCallAnalytics();
            }, 500);
        }

        // ===== PERSISTENT GAME STORAGE FUNCTIONS =====

        function showSaveGameModal() {
            // Get current game name if set
            const currentGameName = document.getElementById('gameName').textContent || '';
            document.getElementById('saveGameName').value = currentGameName;
            
            const modal = new bootstrap.Modal(document.getElementById('saveGameModal'));
            modal.show();
        }

        function showLoadGameModal() {
            loadSavedGamesList();
            const modal = new bootstrap.Modal(document.getElementById('loadGameModal'));
            modal.show();
        }

        function saveCurrentGame() {
            const gameName = document.getElementById('saveGameName').value.trim();
            
            if (!gameName) {
                showAlert('Please enter a game name', 'warning');
                return;
            }

            fetch('/box_stats/save_game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    game_name: gameName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('saveGameModal')).hide();
                } else {
                    showAlert('Error saving game: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error saving game: ' + error.message, 'danger');
            });
        }

        function loadSavedGamesList() {
            fetch('/box_stats/saved_games')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displaySavedGames(data.games);
                } else {
                    showAlert('Error loading saved games: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error loading saved games: ' + error.message, 'danger');
            });
        }

        function displaySavedGames(games) {
            const container = document.getElementById('savedGamesList');
            
            if (games.length === 0) {
                container.innerHTML = '<p class="text-muted">No saved games found.</p>';
                return;
            }

            let html = '';
            games.forEach(game => {
                const gameDate = game.date || 'No date';
                const opponent = game.opponent || 'No opponent';
                const savedAt = new Date(game.saved_at).toLocaleDateString();
                
                html += `
                    <div class="saved-game-item border rounded p-3 mb-2">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="mb-1">${game.game_name}</h6>
                                <small class="text-muted">vs ${opponent} • ${gameDate}</small>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">
                                    ${game.total_plays} plays • ${game.total_players} players<br>
                                    Saved: ${savedAt}
                                </small>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-primary btn-sm me-1" onclick="loadGame('${game.filename}')">
                                    <i class="fas fa-upload"></i> Load
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteGame('${game.filename}', '${game.game_name}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function loadGame(filename) {
            if (!confirm('Loading this game will replace your current session. Continue?')) {
                return;
            }

            fetch('/box_stats/load_game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: filename
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('loadGameModal')).hide();
                    
                    // Refresh the page to load the new game data
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showAlert('Error loading game: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error loading game: ' + error.message, 'danger');
            });
        }

        // NEE Progression Graph Functions
        let neeChart = null;

        function showTeamNeeGraph() {
            const modal = new bootstrap.Modal(document.getElementById('neeGraphModal'));
            document.getElementById('neeGraphModalTitle').textContent = 'Team NEE Progression';
            
            // Show loading
            document.getElementById('neeGraphLoading').style.display = 'block';
            document.getElementById('neeGraphContainer').style.display = 'none';
            
            modal.show();
            
            // Fetch team NEE progression data
            fetch('/box_stats/team_nee_progression')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayProgressionGraph(data.nee_progression, 'Team NEE', data.current_nee, 'nee', '', 'rgb(75, 192, 192)');
                    } else {
                        showAlert('Error loading team NEE data: ' + data.error, 'danger');
                        modal.hide();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error loading team NEE data: ' + error.message, 'danger');
                    modal.hide();
                });
        }

        function showPlayerNeeGraph(playerNumber) {
            const modal = new bootstrap.Modal(document.getElementById('neeGraphModal'));
            
            // Show loading
            document.getElementById('neeGraphLoading').style.display = 'block';
            document.getElementById('neeGraphContainer').style.display = 'none';
            
            modal.show();
            
            // Fetch player NEE progression data
            fetch(`/box_stats/nee_progression/${playerNumber}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const title = `Player #${data.player_number} ${data.player_name} (${data.player_position}) NEE Progression`;
                        document.getElementById('neeGraphModalTitle').textContent = title;
                        displayProgressionGraph(data.nee_progression, `#${data.player_number} ${data.player_name} NEE`, data.current_nee, 'nee', '', 'rgb(75, 192, 192)');
                    } else {
                        showAlert('Error loading player NEE data: ' + data.error, 'danger');
                        modal.hide();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error loading player NEE data: ' + error.message, 'danger');
                    modal.hide();
                });
        }

        // Phase-specific progression graphs
        function showPhaseNeeGraph(phase) {
            const modal = new bootstrap.Modal(document.getElementById('neeGraphModal'));
            const phaseTitle = phase.charAt(0).toUpperCase() + phase.slice(1);
            document.getElementById('neeGraphModalTitle').textContent = `${phaseTitle} NEE Progression`;
            
            // Show loading
            document.getElementById('neeGraphLoading').style.display = 'block';
            document.getElementById('neeGraphContainer').style.display = 'none';
            
            modal.show();
            
            // Fetch phase NEE progression data
            fetch(`/box_stats/phase_nee_progression/${phase}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayProgressionGraph(data.nee_progression, `${phaseTitle} NEE`, data.current_nee, 'nee', '', 'rgb(54, 162, 235)');
                    } else {
                        showAlert(`Error loading ${phase} NEE data: ` + data.error, 'danger');
                        modal.hide();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert(`Error loading ${phase} NEE data: ` + error.message, 'danger');
                    modal.hide();
                });
        }

        function showPhaseEfficiencyGraph(phase) {
            const modal = new bootstrap.Modal(document.getElementById('neeGraphModal'));
            const phaseTitle = phase.charAt(0).toUpperCase() + phase.slice(1);
            document.getElementById('neeGraphModalTitle').textContent = `${phaseTitle} Efficiency Progression`;
            
            // Show loading
            document.getElementById('neeGraphLoading').style.display = 'block';
            document.getElementById('neeGraphContainer').style.display = 'none';
            
            modal.show();
            
            // Fetch phase efficiency progression data
            fetch(`/box_stats/phase_efficiency_progression/${phase}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayProgressionGraph(data.efficiency_progression, `${phaseTitle} Efficiency`, data.current_efficiency, 'efficiency', '%', 'rgb(40, 167, 69)');
                    } else {
                        showAlert(`Error loading ${phase} efficiency data: ` + data.error, 'danger');
                        modal.hide();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert(`Error loading ${phase} efficiency data: ` + error.message, 'danger');
                    modal.hide();
                });
        }

        function showPhaseExplosiveGraph(phase) {
            const modal = new bootstrap.Modal(document.getElementById('neeGraphModal'));
            const phaseTitle = phase.charAt(0).toUpperCase() + phase.slice(1);
            document.getElementById('neeGraphModalTitle').textContent = `${phaseTitle} Explosive Rate Progression`;
            
            // Show loading
            document.getElementById('neeGraphLoading').style.display = 'block';
            document.getElementById('neeGraphContainer').style.display = 'none';
            
            modal.show();
            
            // Fetch phase explosive rate progression data
            fetch(`/box_stats/phase_explosive_progression/${phase}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayProgressionGraph(data.explosive_progression, `${phaseTitle} Explosive Rate`, data.current_explosive_rate, 'explosive', '%', 'rgb(255, 193, 7)');
                    } else {
                        showAlert(`Error loading ${phase} explosive rate data: ` + data.error, 'danger');
                        modal.hide();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert(`Error loading ${phase} explosive rate data: ` + error.message, 'danger');
                    modal.hide();
                });
        }

        // Team Average Yards Graph
        function showTeamAvgYardsGraph() {
            const modal = new bootstrap.Modal(document.getElementById('neeGraphModal'));
            document.getElementById('neeGraphModalTitle').textContent = 'Team Average Yards Progression';
            
            // Show loading
            document.getElementById('neeGraphLoading').style.display = 'block';
            document.getElementById('neeGraphContainer').style.display = 'none';
            
            modal.show();
            
            // Fetch team avg yards progression data
            fetch('/box_stats/team_avg_yards_progression')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayProgressionGraph(data.avg_yards_progression, 'Team Avg Yards', data.current_avg_yards, 'avg_yards', ' yds', 'rgb(255, 193, 7)');
                    } else {
                        showAlert('Error loading team avg yards data: ' + data.error, 'danger');
                        modal.hide();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error loading team avg yards data: ' + error.message, 'danger');
                    modal.hide();
                });
        }

        // Player Efficiency Graph
        function showPlayerEfficiencyGraph(playerNumber) {
            const modal = new bootstrap.Modal(document.getElementById('neeGraphModal'));
            
            // Show loading
            document.getElementById('neeGraphLoading').style.display = 'block';
            document.getElementById('neeGraphContainer').style.display = 'none';
            
            modal.show();
            
            // Fetch player efficiency progression data
            fetch(`/box_stats/efficiency_progression/${playerNumber}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const title = `Player #${data.player_number} ${data.player_name} (${data.player_position}) Efficiency Progression`;
                        document.getElementById('neeGraphModalTitle').textContent = title;
                        displayProgressionGraph(data.efficiency_progression, `#${data.player_number} ${data.player_name} Efficiency`, data.current_efficiency, 'efficiency', '%', 'rgb(40, 167, 69)');
                    } else {
                        showAlert('Error loading player efficiency data: ' + data.error, 'danger');
                        modal.hide();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error loading player efficiency data: ' + error.message, 'danger');
                    modal.hide();
                });
        }

        // Player Average Yards Graph
        function showPlayerAvgYardsGraph(playerNumber) {
            const modal = new bootstrap.Modal(document.getElementById('neeGraphModal'));
            
            // Show loading
            document.getElementById('neeGraphLoading').style.display = 'block';
            document.getElementById('neeGraphContainer').style.display = 'none';
            
            modal.show();
            
            // Fetch player avg yards progression data
            fetch(`/box_stats/avg_yards_progression/${playerNumber}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const title = `Player #${data.player_number} ${data.player_name} (${data.player_position}) Avg Yards Progression`;
                        document.getElementById('neeGraphModalTitle').textContent = title;
                        displayProgressionGraph(data.avg_yards_progression, `#${data.player_number} ${data.player_name} Avg Yards`, data.current_avg_yards, 'avg_yards', ' yds', 'rgb(255, 193, 7)');
                    } else {
                        showAlert('Error loading player avg yards data: ' + data.error, 'danger');
                        modal.hide();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error loading player avg yards data: ' + error.message, 'danger');
                    modal.hide();
                });
        }

        // Generic progression graph display function
        function displayProgressionGraph(progressionData, entityName, currentValue, dataKey, unit, color) {
            // Hide loading and show graph container
            document.getElementById('neeGraphLoading').style.display = 'none';
            document.getElementById('neeGraphContainer').style.display = 'block';
            
            // Destroy existing chart if it exists
            if (neeChart) {
                neeChart.destroy();
            }
            
            // Prepare data for Chart.js
            const labels = progressionData.map(point => `Play ${point.play}`);
            const data = progressionData.map(point => point[dataKey]);
            
            // Create the chart
            const ctx = document.getElementById('neeChart').getContext('2d');
            neeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${entityName}`,
                        data: data,
                        borderColor: color,
                        backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.2)'),
                        borderWidth: 3,
                        fill: true,
                        tension: 0.1,
                        pointBackgroundColor: color,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${entityName} Progression Over Time`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}${unit}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: `Value (${unit.trim()})`
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Play Number'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        point: {
                            hoverBackgroundColor: 'rgb(255, 99, 132)'
                        }
                    }
                }
            });
            
            // Add current value info
            if (progressionData.length === 0) {
                showAlert('No progression data available yet. Add some plays to see the graph!', 'info');
            }
        }

        function deleteGame(filename, gameName) {
            if (!confirm(`Are you sure you want to delete "${gameName}"? This action cannot be undone.`)) {
                return;
            }

            fetch('/box_stats/delete_game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: filename
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    loadSavedGamesList(); // Refresh the list
                } else {
                    showAlert('Error deleting game: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error deleting game: ' + error.message, 'danger');
            });
        }

    </script>

    <!-- Save Game Modal -->
    <div class="modal fade" id="saveGameModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Save Current Game</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="saveGameName" class="form-label">Game Name</label>
                        <input type="text" class="form-control" id="saveGameName" placeholder="Enter game name..." required>
                        <div class="form-text">This will save all plays, player stats, and game information.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="saveCurrentGame()">
                        <i class="fas fa-save me-1"></i>Save Game
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Game Modal -->
    <div class="modal fade" id="loadGameModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Load Saved Game</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Loading a saved game will replace your current session data.
                    </div>
                    <div id="savedGamesList">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
