{% extends "base.html" %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container text-center">
        <h1 class="hero-title">
            <i class="fas fa-football-ball me-3"></i>
            Hoy Sports Data
        </h1>
        <p class="hero-subtitle">
            Professional Football Team Self-Scout Analysis Platform
        </p>
        <p class="mt-4">
            Upload your Excel self-scout data and get instant, professional analytics with interactive visualizations
        </p>
    </div>
</section>

<div class="container">
    <!-- Features Section -->
    <div class="row mb-5">
        <div class="col-md-4 text-center mb-4">
            <div class="feature-icon">
                <i class="fas fa-upload"></i>
            </div>
            <h4>Easy Upload</h4>
            <p class="text-muted">Simply drag and drop your Excel self-scout files for instant analysis</p>
        </div>
        <div class="col-md-4 text-center mb-4">
            <div class="feature-icon">
                <i class="fas fa-chart-bar"></i>
            </div>
            <h4>Advanced Analytics</h4>
            <p class="text-muted">Get detailed statistics and comparisons across different play types</p>
        </div>
        <div class="col-md-4 text-center mb-4">
            <div class="feature-icon">
                <i class="fas fa-eye"></i>
            </div>
            <h4>Interactive Visualizations</h4>
            <p class="text-muted">Explore your data with professional, interactive charts and graphs</p>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-file-excel me-2"></i>
                        Upload Your Self-Scout Excel File
                    </h4>
                </div>
                <div class="card-body">
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                        <h5>Drag & Drop Your Excel File Here</h5>
                        <p class="text-muted mb-3">or click to browse files</p>
                        <input type="file" id="fileInput" class="d-none" accept=".xlsx,.xls">
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open me-2"></i>
                            Choose File
                        </button>
                        <p class="text-muted mt-3 mb-0">
                            <small>Supported formats: .xlsx, .xls (Max size: 16MB)</small>
                        </p>
                    </div>

                    <!-- Loading Spinner -->
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Processing your file...</p>
                    </div>

                    <!-- Alert Messages -->
                    <div id="alertContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sheet Selection Section -->
    <div class="row justify-content-center mt-4" id="sheetSelection" style="display: none;">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Select Sheets to Analyze
                    </h4>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Choose which sheets from your Excel file you want to include in the analysis:</p>
                    <div class="mb-3">
                        <label for="sheetsDropdown" class="form-label">Select sheets to compare:</label>
                        <select id="sheetsDropdown" class="form-select" multiple size="6" style="min-height: 150px;">
                            <!-- Sheet options will be populated here -->
                        </select>
                        <div class="form-text">Hold Ctrl (Windows) or Cmd (Mac) to select multiple sheets</div>
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-success btn-lg" id="analyzeBtn" onclick="analyzeData()">
                            <i class="fas fa-chart-line me-2"></i>
                            Analyze Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" style="display: none;">
        <!-- Summary Stats -->
        <div class="row">
            <div class="col-12">
                <h2 class="text-center mb-4">
                    <i class="fas fa-analytics me-2"></i>
                    Analysis Results
                </h2>
            </div>
        </div>

        <div class="stats-grid" id="summaryStats">
            <!-- Stats will be populated by JavaScript -->
        </div>

        <!-- Run vs Pass Chart -->
        <div class="chart-container">
            <h4 class="mb-3">
                <i class="fas fa-chart-pie me-2"></i>
                Run vs Pass Distribution
            </h4>
            <div id="runPassChart"></div>
        </div>

        <!-- Stat Comparison Section -->
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-balance-scale me-2"></i>
                    Compare Statistics Across Sheets
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="statSelect" class="form-label">Select Statistic to Compare:</label>
                        <select class="form-select" id="statSelect" onchange="compareStats()">
                            <option value="">Choose a statistic...</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container mt-4" id="comparisonChartContainer" style="display: none;">
                    <div id="comparisonChart"></div>
                </div>
            </div>
        </div>

        <!-- Data Preview -->
        <div class="card mt-4">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Data Preview
                </h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="dataPreview">
                        <!-- Table will be populated by JavaScript -->
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentFilename = null;
let selectedSheets = [];
let availableColumns = [];

// File upload handling
document.getElementById('fileInput').addEventListener('change', handleFileSelect);
document.getElementById('uploadArea').addEventListener('click', () => {
    document.getElementById('fileInput').click();
});

// Drag and drop handling
const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        handleFile(file);
    }
}

function handleFile(file) {
    // Validate file type
    if (!file.name.toLowerCase().endsWith('.xlsx') && !file.name.toLowerCase().endsWith('.xls')) {
        showAlert('Please upload an Excel file (.xlsx or .xls)', 'danger');
        return;
    }

    // Validate file size (16MB)
    if (file.size > 16 * 1024 * 1024) {
        showAlert('File size must be less than 16MB', 'danger');
        return;
    }

    uploadFile(file);
}

function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);

    showLoading(true);
    clearAlerts();

    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.success) {
            currentFilename = data.filename;
            displaySheetSelection(data.sheets);
            showAlert('File uploaded successfully!', 'success');
        } else {
            showAlert(data.error || 'Upload failed', 'danger');
        }
    })
    .catch(error => {
        showLoading(false);
        showAlert('Upload failed: ' + error.message, 'danger');
    });
}

function displaySheetSelection(sheets) {
    const dropdown = document.getElementById('sheetsDropdown');
    dropdown.innerHTML = '';

    sheets.forEach(sheet => {
        const option = document.createElement('option');
        option.value = sheet;
        option.textContent = sheet;
        option.selected = true; // Select all sheets by default like Streamlit
        dropdown.appendChild(option);
    });

    document.getElementById('sheetSelection').style.display = 'block';
    document.getElementById('sheetSelection').scrollIntoView({ behavior: 'smooth' });
}

function analyzeData() {
    const dropdown = document.getElementById('sheetsDropdown');
    selectedSheets = Array.from(dropdown.selectedOptions).map(option => option.value);

    if (selectedSheets.length === 0) {
        showAlert('Please select at least one sheet to analyze', 'warning');
        return;
    }

    showLoading(true);
    clearAlerts();

    fetch('/analyze', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            filename: currentFilename,
            sheets: selectedSheets
        })
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.success) {
            displayResults(data);
            showAlert('Analysis complete!', 'success');
        } else {
            showAlert(data.error || 'Analysis failed', 'danger');
        }
    })
    .catch(error => {
        showLoading(false);
        showAlert('Analysis failed: ' + error.message, 'danger');
    });
}

function displayResults(data) {
    // Display summary stats
    displaySummaryStats(data.summary_stats);
    
    // Display run vs pass chart
    if (data.run_pass_chart) {
        try {
            const chartSpec = typeof data.run_pass_chart === 'string' ? JSON.parse(data.run_pass_chart) : data.run_pass_chart;
            vegaEmbed('#runPassChart', chartSpec).catch(console.error);
        } catch (error) {
            console.error('Error rendering run/pass chart:', error);
            document.getElementById('runPassChart').innerHTML = '<p class="text-muted">Chart could not be displayed</p>';
        }
    }
    
    // Populate stat comparison dropdown
    availableColumns = data.available_columns;
    populateStatSelect();
    
    // Show results section
    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

function displaySummaryStats(stats) {
    const container = document.getElementById('summaryStats');
    container.innerHTML = `
        <div class="stat-card">
            <div class="stat-number">${stats.total_plays}</div>
            <div class="stat-label">Total Plays</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${stats.columns.length}</div>
            <div class="stat-label">Data Columns</div>
        </div>
        ${stats.avg_gain ? `
        <div class="stat-card">
            <div class="stat-number">${stats.avg_gain}</div>
            <div class="stat-label">Avg Yards/Play</div>
        </div>
        ` : ''}
        <div class="stat-card">
            <div class="stat-number">${selectedSheets.length}</div>
            <div class="stat-label">Sheets Analyzed</div>
        </div>
    `;
}

function populateStatSelect() {
    const select = document.getElementById('statSelect');
    select.innerHTML = '<option value="">Choose a statistic...</option>';
    
    availableColumns.forEach(([value, display]) => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = display;
        select.appendChild(option);
    });
}

function compareStats() {
    const selectedStat = document.getElementById('statSelect').value;
    if (!selectedStat) {
        document.getElementById('comparisonChartContainer').style.display = 'none';
        return;
    }

    fetch('/compare', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            filename: currentFilename,
            sheets: selectedSheets,
            column: selectedStat
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.chart) {
            try {
                const chartSpec = typeof data.chart === 'string' ? JSON.parse(data.chart) : data.chart;
                vegaEmbed('#comparisonChart', chartSpec).catch(console.error);
                document.getElementById('comparisonChartContainer').style.display = 'block';
            } catch (error) {
                console.error('Error rendering comparison chart:', error);
                document.getElementById('comparisonChart').innerHTML = '<p class="text-muted">Chart could not be displayed</p>';
            }
        } else {
            showAlert(data.error || 'Comparison failed', 'danger');
        }
    })
    .catch(error => {
        showAlert('Comparison failed: ' + error.message, 'danger');
    });
}

function showLoading(show) {
    document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
}

function showAlert(message, type) {
    const container = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    container.appendChild(alert);
    
    // Auto-dismiss success alerts after 5 seconds
    if (type === 'success') {
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
}

function clearAlerts() {
    document.getElementById('alertContainer').innerHTML = '';
}
</script>
{% endblock %}
